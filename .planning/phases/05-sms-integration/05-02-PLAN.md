---
phase: 05-sms-integration
plan: 02
type: execute
---

<objective>
Add UI for manually assigning categories to uncategorized transactions created via SMS or manual entry.

Purpose: Complete the SMS expense logging workflow by allowing users to categorize transactions after quick SMS entry.
Output: Interactive transaction list with inline category editing, Server Action for updates, real-time UI refresh.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sms-integration/05-01-SUMMARY.md
@.planning/phases/04-transaction-system/04-01-SUMMARY.md
@.planning/phases/04-transaction-system/04-02-SUMMARY.md
@app/finance/budgets/[id]/page.tsx
@app/finance/budgets/transactions/actions.ts
@lib/database.types.ts

**Tech stack available:** Next.js 16.1.1 App Router, TypeScript, Tailwind CSS, @supabase/supabase-js@2.90.1

**Established patterns:**
- Server Actions for mutations (createTransaction, deleteTransaction exist)
- Server Components for data fetching
- Optimistic updates with revalidatePath
- Inline editing with state management

**Constraining decisions:**
- Phase 04-01: Transaction list displays transactions grouped by date with category names
- Phase 04-02: Manual entry form uses category dropdown (pattern to reuse)
- Phase 05-01: SMS creates uncategorized transactions (category_id = null)
- Transactions table has nullable category_id column
- Categories table exists with id, name, user_id columns

**Current state:**
- Transaction list shows "Uncategorized" for null category_id
- No way to change category after transaction creation
- SMS transactions accumulate as uncategorized

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create updateTransactionCategory Server Action</name>
  <files>app/finance/budgets/transactions/actions.ts</files>
  <action>
Add updateTransactionCategory Server Action to existing actions.ts file.

Function signature:
```typescript
export async function updateTransactionCategory(
  transactionId: number,
  categoryId: number | null
): Promise<{ success: boolean; error?: string }>
```

Implementation:
1. Create Supabase client with createClient()
2. Update transactions table: `update({ category_id: categoryId }).eq('id', transactionId).eq('user_id', TEMP_USER_ID)`
3. Check for error, return { success: false, error: message } if failed
4. Get transaction's budget_id for revalidation: `select('budget_id').eq('id', transactionId).single()`
5. Use revalidatePath(`/finance/budgets/${budgetId}`) to refresh UI
6. Return { success: true }

Security: Filter by user_id (TEMP_USER_ID) to prevent cross-user updates

Error handling:
- Transaction not found → return { success: false, error: 'Transaction not found' }
- Category not found (if categoryId not null) → let database FK handle it
- Database error → return { success: false, error: error.message }
  </action>
  <verify>Export exists, TypeScript types correct, follows existing Server Action pattern in file</verify>
  <done>Server Action created, handles success/error cases, revalidates UI after update</done>
</task>

<task type="auto">
  <name>Task 2: Add inline category editor to transaction list</name>
  <files>app/finance/budgets/[id]/page.tsx, components/finance/transaction-row.tsx (new)</files>
  <action>
Create client component for transaction row with inline editing.

Create components/finance/transaction-row.tsx:
1. Accept props: transaction (with id, amount, note, category_id, category name)
2. Add state: `const [isEditing, setIsEditing] = useState(false)`
3. Add state: `const [selectedCategory, setSelectedCategory] = useState(transaction.category_id)`
4. Fetch categories for dropdown: useEffect or pass as prop from parent
5. Render two modes:
   - View mode: Display category name (or "Uncategorized"), show pencil icon button to enter edit mode
   - Edit mode: Show category dropdown/select, Save button, Cancel button
6. On Save: Call updateTransactionCategory(transaction.id, selectedCategory) using useTransition for pending state
7. Show loading state during update
8. On success: Exit edit mode (setIsEditing(false))
9. On error: Show error message, stay in edit mode

Category selector:
- Display existing categories from categories table
- Include "Uncategorized" option (value: null)
- Use select element or custom dropdown component
- Show current category as selected by default

UI polish:
- Pencil icon only shows on hover for clean look
- Edit mode highlights row (border or background change)
- Disable edit button while saving (prevent double-submit)
- Use Tailwind for styling, mobile-friendly

Update app/finance/budgets/[id]/page.tsx:
- Replace static transaction display with TransactionRow component
- Pass categories list to TransactionRow (fetch once in Server Component)
- Keep date grouping structure
  </action>
  <verify>Component renders, edit mode toggles, category dropdown populated, pencil icon appears</verify>
  <done>Inline editor working, smooth toggle between view/edit modes, categories loaded</done>
</task>

<task type="auto">
  <name>Task 3: Wire up category update with optimistic UI</name>
  <files>components/finance/transaction-row.tsx</files>
  <action>
Implement the save flow in TransactionRow component.

1. Import updateTransactionCategory Server Action
2. Import useTransition from React for pending state
3. Add transition wrapper:
   ```typescript
   const [isPending, startTransition] = useTransition()
   ```
4. On Save button click:
   ```typescript
   startTransition(async () => {
     const result = await updateTransactionCategory(transaction.id, selectedCategory)
     if (result.success) {
       setIsEditing(false)
       // UI auto-refreshes via revalidatePath in Server Action
     } else {
       setError(result.error)
       // Stay in edit mode, show error
     }
   })
   ```
5. Show pending state: Disable Save button, show spinner or "Saving..." text
6. Handle Cancel: Reset selectedCategory to original, exit edit mode
7. Add error state display: Show error message in red below dropdown if update fails

Edge cases:
- User changes category then immediately cancels → revert to original
- Multiple rapid clicks on Save → disabled during isPending prevents duplicates
- Network error → show error, allow retry
- Category deleted between load and save → Server Action FK error, show "Category no longer exists"

Accessibility:
- Keyboard navigation: Tab between dropdown/Save/Cancel, Enter to save, Escape to cancel
- ARIA labels: aria-label="Edit category" on pencil button
- Focus management: Focus dropdown when entering edit mode
  </action>
  <verify>Save updates database, UI refreshes showing new category, Cancel reverts changes, error messages display correctly</verify>
  <done>Full save flow working, optimistic updates, error handling, accessible keyboard navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Manual transaction categorization UI with inline editing and Server Action updates</what-built>
  <how-to-verify>
1. Start dev server: npm run dev

2. Navigate to budget detail page:
   - Visit: http://localhost:3000/finance/budgets
   - Click on a budget to view transactions

3. Test uncategorized transaction (from SMS):
   - Find an uncategorized transaction in the list
   - Hover over the row → verify pencil/edit icon appears
   - Click edit icon
   - Verify: Dropdown shows with categories + "Uncategorized" option
   - Select a category (e.g., "Food")
   - Click Save
   - Verify: Transaction updates to show "Food" category
   - Verify: No page reload, smooth update
   - Refresh page manually → verify category persisted

4. Test changing existing category:
   - Find a transaction with a category already assigned
   - Click edit icon
   - Change category to different one
   - Click Save
   - Verify: Updates correctly

5. Test setting to Uncategorized:
   - Edit a categorized transaction
   - Select "Uncategorized" from dropdown
   - Click Save
   - Verify: Shows "Uncategorized" after update

6. Test Cancel:
   - Start editing a transaction
   - Change category in dropdown
   - Click Cancel (don't save)
   - Verify: Reverts to original category, exits edit mode

7. Test keyboard navigation:
   - Tab to edit button, press Enter
   - Tab through dropdown, Save, Cancel
   - Press Escape to cancel
   - Verify: All keyboard interactions work

8. Test error handling:
   - Open browser DevTools Network tab
   - Go offline or block requests
   - Try to save category change
   - Verify: Error message displays
   - Go back online
   - Retry save
   - Verify: Works after retry

9. Test mobile responsiveness:
   - Resize browser to mobile width
   - Verify: Edit controls still accessible and functional
   - Verify: Dropdown doesn't overflow screen

10. Check database directly (optional):
    - Query transactions table in Supabase dashboard
    - Verify: category_id column updates match UI changes
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] updateTransactionCategory Server Action created and exported
- [ ] TransactionRow component renders with view/edit modes
- [ ] Edit icon appears on hover
- [ ] Category dropdown populated with all categories + Uncategorized
- [ ] Save updates database and refreshes UI
- [ ] Cancel reverts changes without saving
- [ ] Error messages display on failure
- [ ] Keyboard navigation works (Tab, Enter, Escape)
- [ ] Mobile responsive
- [ ] npm run build succeeds without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Uncategorized transactions can be categorized via inline editing
- UI updates immediately after save
- Error handling graceful
- Accessible keyboard navigation
- Phase 5 complete - SMS to categorized transaction workflow complete
- Ready for Phase 6 (Analytics Dashboard)
</success_criteria>

<output>
After completion, create `.planning/phases/05-sms-integration/05-02-SUMMARY.md`:

# Phase 5 Plan 2: Manual Transaction Categorization Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 5 complete. Ready for Phase 6 (Analytics Dashboard) - `/gsd:plan-phase 6`
</output>
