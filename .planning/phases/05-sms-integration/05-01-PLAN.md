---
phase: 05-sms-integration
plan: 01
type: execute
---

<objective>
Implement Twilio SMS webhook to parse "amount note" messages and create uncategorized transactions automatically (categories assigned later in UI).

Purpose: Enable zero-friction expense logging via text message - the core value proposition of the app.
Output: Working SMS webhook that creates transactions from texts like "$25 coffee at starbucks".
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sms-integration/05-RESEARCH.md
@.planning/phases/04-transaction-system/04-02-SUMMARY.md
@.planning/phases/02-supabase-backend/02-02-SUMMARY.md
@app/finance/budgets/transactions/actions.ts
@lib/supabase/server.ts
@lib/database.types.ts

**Tech stack available:** @supabase/supabase-js@2.90.1, @supabase/ssr@0.8.0, Next.js 16.1.1 App Router, TypeScript

**Established patterns:**
- Server Components for data fetching
- Server Actions for mutations (createTransaction, deleteTransaction already exist)
- Next.js Route Handlers for webhooks
- Hardcoded TEMP_USER_ID (00000000-0000-0000-0000-000000000000)

**Constraining decisions:**
- Phase 02-02: transactions table has twilio_message_id column (nullable text) for idempotency, twilio_from column (nullable text) for sender tracking
- Phase 04-02: createTransaction Server Action exists, takes amount, category_id (nullable), note, transaction_date, budget_id, user_id, source
- From RESEARCH.md: Use twilio SDK validateRequest(), regex parsing (not NLP), MessageSid for idempotency, respond within 15 seconds
- **Design decision:** SMS creates uncategorized transactions (category_id = null), categories assigned later in UI for simpler UX

**Issues being addressed:** None

**From RESEARCH.md - Don't hand-roll:**
- Webhook signature validation - MUST use twilio.validateRequest() (handles HMAC-SHA1, URL encoding, evolving parameters)
- Phone number formatting - use Twilio SDK utilities if needed
- SMS sending - use Twilio SDK (this phase is receive-only)

**From RESEARCH.md - Common pitfalls:**
- URL mismatch in signature validation (use exact URL from env var)
- 15-second timeout (respond immediately, no slow processing)
- Missing idempotency (check MessageSid before creating transaction)
- Form-urlencoded body parsing in App Router (use request.text() + URLSearchParams)
- Overly strict parsing (be permissive: accept $25, 25, 25.50)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Twilio SDK and create SMS webhook Route Handler</name>
  <files>package.json, app/api/sms/route.ts</files>
  <action>
Install Twilio Node.js SDK: `npm install twilio`

Create app/api/sms/route.ts as Next.js Route Handler (POST only). Structure:
1. Extract X-Twilio-Signature header
2. Parse form-urlencoded body using `await request.text()` then `new URLSearchParams(body)` to get params object
3. Validate signature using `twilio.validateRequest(authToken, signature, url, params)` where:
   - authToken: process.env.TWILIO_AUTH_TOKEN
   - url: `${process.env.NEXT_PUBLIC_URL}/api/sms` (MUST match Twilio console config exactly)
4. Return 401 "Unauthorized" if validation fails
5. Extract MessageSid, From, Body from params
6. For now, return empty TwiML response: `<?xml version="1.0" encoding="UTF-8"?><Response></Response>` with Content-Type: text/xml
7. Add environment variables to .env.local.example: TWILIO_AUTH_TOKEN, NEXT_PUBLIC_URL

DO NOT implement parsing or transaction creation yet - this task is webhook validation only.

From RESEARCH.md: Twilio sends application/x-www-form-urlencoded POST requests. Next.js App Router requires manual parsing via request.text(). Always use Twilio SDK for validation (don't implement HMAC-SHA1 yourself - parameters evolve without notice).
  </action>
  <verify>npm run build succeeds with no TypeScript errors, route.ts compiles correctly</verify>
  <done>Webhook Route Handler exists, signature validation implemented using Twilio SDK, returns TwiML response, env vars documented</done>
</task>

<task type="auto">
  <name>Task 2: Implement SMS text parser</name>
  <files>lib/twilio/parser.ts</files>
  <action>
Create lib/twilio/parser.ts with parseSMS function that extracts amount and note from SMS body.

Parsing logic (from RESEARCH.md code example):
1. Extract amount: Use regex `/\$?(\d+(?:\.\d{1,2})?)/` to match optional $, digits, optional .XX
   - Accept: "$25", "25", "25.50", "25.5" (normalize to 2 decimals)
   - parseFloat() the matched group
2. Remove amount from text, trim remaining text
3. Remaining text = note (or null if none)

Return interface: `{ amount: number | null, note: string | null }`

Examples:
- "$25 coffee at starbucks" → { amount: 25, note: "coffee at starbucks" }
- "25.50 trader joes" → { amount: 25.50, note: "trader joes" }
- "100" → { amount: 100, note: null }

From RESEARCH.md: Be permissive with parsing. Accept multiple amount formats. Default missing fields to null rather than rejecting. Don't use NLP libraries - regex is sufficient for controlled "amount note" format. Categories are assigned later in the UI, not via SMS.
  </action>
  <verify>Unit test parseSMS with various inputs, verify parsing handles edge cases ($25, 25, 25.5, "25 coffee at starbucks", "25.50 trader joes")</verify>
  <done>Parser extracts amount/note correctly, handles edge cases (missing note, various amount formats)</done>
</task>

<task type="auto">
  <name>Task 3: Integrate parser with transaction creation and idempotency</name>
  <files>app/api/sms/route.ts</files>
  <action>
Update app/api/sms/route.ts to process SMS and create transactions:

1. After signature validation, check idempotency FIRST:
   - Query transactions table: `eq('twilio_message_id', MessageSid)`
   - If exists, return success TwiML immediately (already processed)

2. Parse SMS body using parseSMS(Body)
   - If amount is null, return TwiML error message: `<Response><Message>Could not parse amount. Format: "$25 coffee at starbucks"</Message></Response>`

3. Determine budget_id:
   - Query budgets table for TEMP_USER_ID
   - Get most recent budget: `order('month', { ascending: false }).limit(1)`
   - If no budget exists, return TwiML error: `<Response><Message>No budget found. Create a budget first at [app URL]</Message></Response>`

4. Create uncategorized transaction (NOT the Server Action - direct Supabase insert for speed):
   - Insert into transactions: amount, category_id: null, note (nullable), transaction_date (now), budget_id, user_id (TEMP_USER_ID), source: 'sms', twilio_message_id: MessageSid, twilio_from: From
   - Categories will be assigned later in the UI

5. Use revalidatePath(`/finance/budgets/${budget_id}`) to refresh UI

6. Return success TwiML: `<Response></Response>` (empty = silent success, no SMS reply)

From RESEARCH.md: Respond within 15 seconds (Twilio timeout). Check MessageSid for idempotency before any processing. Twilio retries on timeout, causing duplicate transactions if not handled. Use database insert directly in webhook (Server Actions are for client-side forms, webhooks need raw speed).
  </action>
  <verify>Test with curl POST to /api/sms with Twilio-formatted body, verify transaction created with category_id=null, verify duplicate MessageSid doesn't create duplicate transaction</verify>
  <done>Webhook creates uncategorized transactions from SMS, idempotency prevents duplicates, budget assignment automatic, responds within 15 seconds, UI refreshes after transaction creation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>SMS webhook with Twilio signature validation, text parsing, and transaction creation</what-built>
  <how-to-verify>
1. Add Twilio credentials to .env.local:
   - TWILIO_AUTH_TOKEN=your_auth_token (from Twilio console)
   - NEXT_PUBLIC_URL=http://[ngrok-url] (see step 3)

2. Run: npm run dev

3. Set up ngrok for local testing:
   - Install ngrok: `brew install ngrok` or download from ngrok.com
   - Run: `ngrok http 3000`
   - Copy the HTTPS URL (e.g., https://abc123.ngrok.io)
   - Update NEXT_PUBLIC_URL in .env.local with ngrok URL
   - Restart dev server

4. Configure Twilio webhook:
   - Go to Twilio Console → Phone Numbers → Your number
   - Under "Messaging", set "A MESSAGE COMES IN" webhook to: `https://[ngrok-url]/api/sms`
   - HTTP POST
   - Save

5. Test SMS parsing:
   - Text your Twilio number: "$25 coffee at starbucks"
   - Visit: http://localhost:3000/finance/budgets
   - Click on current budget
   - Verify: Transaction appears with amount $25, note "coffee at starbucks", category "Uncategorized"
   - Verify: Spending summary updates

6. Test various formats:
   - Text: "15.50 lunch burrito downtown"
   - Text: "100"
   - Text: "$5 snack"
   - Verify all create transactions with correct amount/note parsing, all uncategorized

7. Test idempotency:
   - Send same message twice quickly
   - Verify: Only ONE transaction created (duplicate prevented)

8. Test invalid input:
   - Text: "hello" (no amount)
   - Check phone: Should receive error SMS "Could not parse amount..."

9. Check webhook logs in terminal for any errors

10. Verify: Transactions have source='sms', twilio_message_id populated
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without errors
- [ ] SMS webhook validates Twilio signatures correctly
- [ ] Text parsing extracts amount and note from various formats
- [ ] Transactions created with source='sms', category_id=null, and twilio_message_id
- [ ] Idempotency prevents duplicate transactions
- [ ] Budget assignment automatic (most recent budget)
- [ ] UI updates via revalidatePath
- [ ] Webhook responds within 15 seconds
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- SMS-to-transaction flow works end-to-end
- Twilio signature validation using SDK (not custom)
- Idempotency implemented via MessageSid
- Phase 5 complete - core value proposition (zero-friction SMS logging) delivered
- Ready for Phase 6 (Analytics Dashboard)
</success_criteria>

<output>
After completion, create `.planning/phases/05-sms-integration/05-01-SUMMARY.md`:

# Phase 5 Plan 1: SMS Integration Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 5 complete. Ready for Phase 6 (Analytics Dashboard) - `/gsd:plan-phase 6`
</output>
