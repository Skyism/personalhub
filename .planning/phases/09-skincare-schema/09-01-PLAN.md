---
phase: 09-skincare-schema
plan: 01
type: execute
---

<objective>
Create Supabase database schema for skincare reminder settings, morning message, and night messages list.

Purpose: Establish the database foundation for SMS reminder functionality - storing user preferences for morning/night reminders, scheduling times, and customizable message content.
Output: Database migration applied with skincare_settings and night_messages tables, Row Level Security policies, and TypeScript types generated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/skincare-req.md
@supabase/migrations/20260111_create_finance_schema.sql
@.planning/phases/02-supabase-backend/02-02-SUMMARY.md

**Established patterns from Finance module (Phase 2):**
- `numeric(10,2)` for currency amounts
- `timestamptz` for timestamps
- Single-user RLS policies with `auth.uid() = user_id`
- Indexed foreign keys for query performance
- Generated identity columns for primary keys
- CASCADE on user deletion, SET NULL for optional references

**Requirements from skincare-req.md:**
- Morning reminder: single persistent message (same every day)
- Night reminder: list of messages (random selection)
- Configurable times (default: 8:00 AM morning, 10:30 PM night)
- Enable/disable toggles for morning and night reminders
- Message persistence across restarts and deployments

**Tech stack available:**
- Supabase MCP tools for schema management
- TypeScript types generation from schema
- Row Level Security for single-user access
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skincare schema migration</name>
  <files>supabase/migrations/20260114_create_skincare_schema.sql</files>
  <action>
Create migration file with two tables:

**skincare_settings table:**
- id (bigint, generated identity, primary key)
- user_id (uuid, references auth.users(id), ON DELETE CASCADE)
- morning_enabled (boolean, default true)
- morning_message (text, NOT NULL)
- morning_time (time, NOT NULL, default '08:00:00')
- night_enabled (boolean, default true)
- night_time (time, NOT NULL, default '22:30:00')
- created_at (timestamptz, default now())
- updated_at (timestamptz, default now())
- Add UNIQUE constraint on user_id (one settings row per user)

**night_messages table:**
- id (bigint, generated identity, primary key)
- user_id (uuid, references auth.users(id), ON DELETE CASCADE)
- message (text, NOT NULL)
- created_at (timestamptz, default now())
- Index on user_id for query performance

**Enable RLS** on both tables.

**RLS Policies** (following Finance Phase 2 patterns):
For skincare_settings: SELECT, INSERT, UPDATE, DELETE policies using `auth.uid() = user_id`
For night_messages: SELECT, INSERT, UPDATE, DELETE policies using `auth.uid() = user_id`

Use `time` type (not timestamptz) for morning_time/night_time since these are daily recurring times without timezone context (scheduler will apply user's timezone when sending).
  </action>
  <verify>Check file exists: `ls supabase/migrations/20260114_create_skincare_schema.sql`</verify>
  <done>Migration file created with 2 tables, indexes, RLS enabled, 8 policies total</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration to Supabase</name>
  <files>N/A (database operation)</files>
  <action>
Apply the migration using Supabase MCP tool `mcp__plugin_supabase_supabase__apply_migration`:
- project_id: from environment or ask user if needed
- name: "create_skincare_schema"
- query: contents of the migration file

Verify migration applied successfully by checking for tables in database.
  </action>
  <verify>Use `mcp__plugin_supabase_supabase__list_tables` with schemas: ["public"] to confirm skincare_settings and night_messages tables exist</verify>
  <done>Migration applied, tables visible in Supabase, RLS policies active</done>
</task>

<task type="auto">
  <name>Task 3: Generate TypeScript types</name>
  <files>lib/database.types.ts</files>
  <action>
Use Supabase MCP tool `mcp__plugin_supabase_supabase__generate_typescript_types` to regenerate types from schema. This will add types for:
- SkincareSettings (Row, Insert, Update)
- NightMessages (Row, Insert, Update)

Append to existing lib/database.types.ts (don't overwrite Finance types).

Run `npx tsc --noEmit` to verify TypeScript compilation passes with new types.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit` returns exit code 0</verify>
  <done>Types generated, TypeScript compilation clean, new tables type-safe</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration file exists in supabase/migrations/
- [ ] Tables exist in Supabase database (list_tables confirms)
- [ ] RLS policies are enabled (check Supabase dashboard or query pg_policies)
- [ ] TypeScript types generated for new tables
- [ ] `npx tsc --noEmit` passes without errors
</verification>

<success_criteria>
- All tasks completed
- Migration applied successfully to Supabase
- skincare_settings and night_messages tables created
- RLS policies active on both tables
- TypeScript types available for type-safe queries
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-skincare-schema/09-01-SUMMARY.md`:

---
phase: 09-skincare-schema
plan: 01
status: complete
subsystem: skincare
tags: [supabase, database, rls, schema-migration, typescript]

# Dependency graph
requires:
  - phase: 02-01
    provides: [supabase-client-utilities]
  - phase: 02-02
    provides: [finance-database-schema, rls-policies]
provides:
  - skincare-database-schema
  - skincare-settings-table
  - night-messages-table
  - skincare-rls-policies
  - skincare-typescript-types
affects: [10, 11, 12]

# Tech tracking
tech-stack:
  added: []
  patterns: [row-level-security, time-for-daily-scheduling, one-to-many-messages]

key-files:
  created:
    - supabase/migrations/20260114_create_skincare_schema.sql
  modified:
    - lib/database.types.ts

key-decisions:
  - "Using time type (not timestamptz) for reminder times - daily recurring without timezone"
  - "Separate night_messages table for message rotation (one-to-many relationship)"
  - "Single skincare_settings row per user (UNIQUE constraint on user_id)"
  - "Enable/disable toggles for morning and night reminders independently"

patterns-established:
  - "One settings row per user pattern (UNIQUE constraint)"
  - "Separate table for list-type data (night_messages vs embedded array)"

issues-created: []

# Metrics
duration: [filled during execution]
completed: [filled during execution]
---

# Phase 9 Plan 1: Skincare Schema - Summary

**Skincare reminder database schema deployed with settings and night messages tables.**

## Accomplishments

- Created database migration with skincare_settings and night_messages tables
- Applied migration to Supabase
- Enabled Row Level Security on both tables
- Created 8 RLS policies (4 per table) for single-user access
- Indexed night_messages.user_id for query performance
- Generated TypeScript types for type-safe queries
- Verified TypeScript compilation passes

## Files Created/Modified

- `supabase/migrations/20260114_create_skincare_schema.sql` - Complete schema with tables, indexes, RLS
- `lib/database.types.ts` - Updated with SkincareSettings and NightMessages types

## Decisions Made

[Document any deviations or additional decisions during execution]

## Issues Encountered

[Document any issues, or write "None"]

## Next Phase Readiness

**Phase 10 (Settings UI)** is ready to proceed.

The backend provides:
- Database tables for storing reminder settings and messages
- RLS policies ensuring users only access their own data
- TypeScript types for type-safe database operations
- Supabase client utilities (from Phase 2) for querying from UI

Database structure supports:
- Morning reminder with single persistent message
- Night reminder with list of rotating messages
- Configurable times for both reminders
- Enable/disable toggles for independent control

---

*Phase: 09-skincare-schema*
*Plan: 01 of 1*
*Completed: [date]*
</output>
