---
phase: 10-settings-ui
plan: 02
type: execute
---

<objective>
Add night reminder configuration form with rotating message list management.

Purpose: Complete settings UI with night reminder toggle, time picker, and CRUD interface for managing multiple rotating night messages.
Output: Fully functional settings page with both morning and night reminder configuration, following established Finance module patterns for list management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-skincare-schema/09-01-SUMMARY.md
@.planning/phases/10-settings-ui/10-01-SUMMARY.md

# Key files from prior work:
@supabase/migrations/20260114_create_skincare_schema.sql
@app/finance/categories/page.tsx
@app/finance/categories/CategoryCard.tsx
@app/finance/categories/CreateCategoryForm.tsx
@app/skincare/settings/page.tsx
@app/skincare/settings/MorningReminderForm.tsx
@app/skincare/settings/actions.ts

**Tech stack available:**
- Next.js App Router with Server/Client Component split
- Supabase client utilities (browser + server)
- shadcn/ui Card, Button, Input components
- Tokyo Night color palette with semantic tokens
- Plus Jakarta Sans typography

**Established patterns:**
- Toggle-based forms (collapsed by default, expand on click) - CreateCategoryForm.tsx
- Inline edit/delete UI with Client Component islands - CategoryCard.tsx
- Server Actions with validation and revalidatePath
- TEMP_USER_ID workaround (00000000-0000-0000-0000-000000000000)
- List display with map() and empty states
- inputMode attributes and character counters for mobile

**Constraining decisions:**
- Phase 9: night_messages table has one-to-many relationship with users
- Phase 9: night_time stored as `time` type (default 22:30:00)
- Phase 10 Plan 1: 160-char limit with counter pattern established for messages
- Phase 3 Plan 2: Toggle-based form display (collapsed by default, opens on click)
- Phase 3 Plan 2: Inline edit/delete pattern with Client Component islands

**Database schema** (from Phase 9):
- `skincare_settings.night_enabled` (boolean), `skincare_settings.night_time` (time)
- `night_messages` table: id, user_id, message (text), created_at
- Indexed on user_id for query performance
- RLS policies enabled for single-user access
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update settings page to fetch and display night messages</name>
  <files>app/skincare/settings/page.tsx</files>
  <action>
Update app/skincare/settings/page.tsx Server Component to:
1. Add second query for night_messages table: .from('night_messages').select('*').eq('user_id', TEMP_USER_ID).order('created_at', { ascending: false })
2. Pass both skincare_settings and night_messages data to components
3. Add <NightReminderForm /> Client Component below MorningReminderForm, passing initialSettings and nightMessages props
4. Keep Server Component pattern - no 'use client' directive on page.tsx

The page should now fetch two datasets: skincare_settings (single row) and night_messages (array of messages).
  </action>
  <verify>TypeScript compiles. npm run build succeeds. page.tsx queries both tables and passes data to NightReminderForm.</verify>
  <done>Settings page fetches night_messages from database and passes to NightReminderForm component.</done>
</task>

<task type="auto">
  <name>Task 2: Build night reminder configuration form with message list CRUD</name>
  <files>app/skincare/settings/NightReminderForm.tsx, app/skincare/settings/NightMessageItem.tsx, app/skincare/settings/actions.ts (append)</files>
  <action>
Create Client Component at app/skincare/settings/NightReminderForm.tsx:
1. 'use client' directive
2. Props: { initialSettings: Database['public']['Tables']['skincare_settings']['Row'] | null, nightMessages: Database['public']['Tables']['night_messages']['Row'][] }
3. State: nightEnabled (boolean), nightTime (string HH:MM), isSubmitting (boolean), error (string | null), showAddForm (boolean), newMessage (string)
4. Initialize from initialSettings: enabled=true, time='22:30', showAddForm=false, newMessage=''
5. Form structure:
   - Card with CardHeader "Night Reminders"
   - Toggle for nightEnabled with label "Enable Night Reminder"
   - Input type="time" for nightTime, disabled if !nightEnabled
   - Button "Update Night Settings" calls updateNightSettings Server Action
   - Section: "Night Messages" with description "Add multiple messages that will rotate each night"
   - List of <NightMessageItem /> components (one per message in nightMessages array), show empty state if nightMessages.length === 0
   - Button "+ Add Night Message" (only shown if nightEnabled) toggles showAddForm
   - If showAddForm: Textarea for newMessage (160 char limit with counter), "Save Message" button calls createNightMessage Server Action, "Cancel" button closes form
6. Apply mobile optimizations: inputMode="text" on textarea, autoComplete="off", disabled styling during submission
7. Character counter: {newMessage.length}/160

Create Client Component at app/skincare/settings/NightMessageItem.tsx:
1. 'use client' directive
2. Props: { message: Database['public']['Tables']['night_messages']['Row'] }
3. State: isEditing (boolean), editedMessage (string), isSubmitting (boolean)
4. If !isEditing: Display message.message text with Edit and Delete buttons (small, secondary variant)
5. If isEditing: Textarea with editedMessage (160 char limit + counter), Save/Cancel buttons, calls updateNightMessage Server Action
6. Delete button calls deleteNightMessage Server Action with confirmation (if (confirm('Delete this message?')))
7. Follow CategoryCard.tsx inline edit/delete pattern

Update app/skincare/settings/actions.ts with 4 new Server Actions:
1. **updateNightSettings(enabled: boolean, time: string)**: Updates skincare_settings.night_enabled and night_time. Validation: time matches /^\d{2}:\d{2}$/, convert to HH:MM:SS. Use upsert logic (UPDATE if exists, INSERT if not). Return { success, error? }.
2. **createNightMessage(message: string)**: Inserts into night_messages table. Validation: message.length ≤ 160, message.trim() not empty. INSERT (user_id, message) VALUES (TEMP_USER_ID, message). Revalidate /skincare/settings. Return { success, error? }.
3. **updateNightMessage(id: number, message: string)**: Updates existing night message. Validation: message.length ≤ 160. UPDATE night_messages SET message WHERE id=id AND user_id=TEMP_USER_ID. Revalidate. Return { success, error? }.
4. **deleteNightMessage(id: number)**: Deletes night message. DELETE FROM night_messages WHERE id=id AND user_id=TEMP_USER_ID. Revalidate. Return { success, error? }.

Follow CreateCategoryForm.tsx (toggle-based form) and CategoryCard.tsx (inline edit/delete) patterns. All Server Actions must use 'use server', revalidatePath('/skincare/settings'), and return { success: boolean, error?: string }.
  </action>
  <verify>NightReminderForm.tsx and NightMessageItem.tsx exist. actions.ts has 4 new exported functions. TypeScript compiles. Manual test: toggle night reminder, update time, add/edit/delete messages. Each operation revalidates page.</verify>
  <done>Night reminder form functional with toggle, time picker, message list display, add/edit/delete operations via Server Actions, all following established Finance module patterns.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] TypeScript compilation passes
- [ ] Night reminder form renders with toggle and time picker
- [ ] Message list displays all night_messages from database
- [ ] Add message form appears/disappears on button click
- [ ] Creating message adds to database and revalidates
- [ ] Editing message updates database inline
- [ ] Deleting message removes from database with confirmation
- [ ] Character counters work on all message inputs
- [ ] All forms disable inputs during submission
</verification>

<success_criteria>

- All tasks completed
- Settings page displays both morning and night reminder forms
- Night reminder form has toggle, time picker, and message list
- CRUD operations for night messages: create, edit, delete
- 4 Server Actions in actions.ts handle night settings and messages
- Validation enforces 160-char limit on all messages
- Inline edit pattern matches CategoryCard.tsx
- Toggle-based add form matches CreateCategoryForm.tsx
- Empty state shown when no night messages exist
- Confirmation dialog on delete operation
- No TypeScript errors or build failures
- Phase 10 complete, ready for Phase 11 (Scheduler Setup)
</success_criteria>

<output>
After completion, create `.planning/phases/10-settings-ui/10-02-SUMMARY.md`:

# Phase 10 Plan 2: Night Reminder Configuration Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

**Phase 11 (Scheduler Setup)** is ready to proceed.

The UI provides:
- Complete settings management for morning and night reminders
- Database CRUD operations for all reminder settings
- Message rotation list (night_messages table) for scheduler to consume
- Enable/disable toggles to control which reminders scheduler should send
- Time configuration for scheduler to determine when to send
</output>
