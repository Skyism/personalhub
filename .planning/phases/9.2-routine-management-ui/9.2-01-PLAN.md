---
phase: 9.2
plan: 1
wave: 1
subsystem: skincare-ui
tags: [server-actions, ui, supabase, crud]
---

# Plan 9.2-01: Routine Management Foundation

## Objective

Build the foundation for routine editing: Server Actions for CRUD operations on skincare_routines table, and the day selector UI that allows users to choose which day's routine to edit.

**Why this matters:** Establishes the data layer and navigation structure for the entire routine management feature.

## Context

- `.planning/phases/9.1-skincare-routine-schema/9.1-01-SUMMARY.md` — Schema with 14 weekly slots (7 days × 2 times)
- `supabase/migrations/20260119_create_skincare_routine_schema.sql` — Table structure with JSONB steps
- `lib/skincare-seed.ts` — Sample data structure and DAYS_OF_WEEK helpers
- `app/finance/wants/actions.ts` — Reference pattern for Server Actions
- `lib/database.types.ts` — TypeScript types including SkincareRoutines

## Tasks

<task type="auto">
  <name>Create Server Actions for routine CRUD operations</name>
  <files>app/skincare/routines/actions.ts</files>
  <action>
    Create Server Actions file with CRUD operations for skincare_routines:
    
    **Functions to implement:**
    1. `getRoutines(dayOfWeek?: number)` — Fetch routines (all or filtered by day)
    2. `upsertRoutine(dayOfWeek: number, timeOfDay: 'morning' | 'night', steps: Array<{id: string, order: number, text: string}>)` — Insert or update routine
    3. `deleteRoutine(dayOfWeek: number, timeOfDay: 'morning' | 'night')` — Delete routine (clear steps)
    
    **Implementation requirements:**
    - Use 'use server' directive at top
    - Import createClient from '@/lib/supabase/server'
    - Use TEMP_USER_ID = '00000000-0000-0000-0000-000000000000' (matches Finance pattern)
    - Use upsert with conflict resolution on (user_id, day_of_week, time_of_day) unique constraint
    - Call revalidatePath('/skincare/routines') after mutations
    - Throw errors with descriptive messages on Supabase errors
    - Return { success: true } on successful mutations
    
    **What to avoid:**
    - Don't use client-side Supabase client — this is server-only
    - Don't forget revalidatePath — needed for UI updates
    - Don't hardcode user_id in queries — use TEMP_USER_ID constant
  </action>
  <verify>grep -q "use server" app/skincare/routines/actions.ts && grep -q "upsertRoutine" app/skincare/routines/actions.ts</verify>
  <done>Server Actions file exists with getRoutines, upsertRoutine, and deleteRoutine functions using established patterns</done>
</task>

<task type="auto">
  <name>Create routine management page with day selector</name>
  <files>app/skincare/routines/page.tsx</files>
  <action>
    Create the routine management page at /skincare/routines with day-of-week selector:
    
    **Page structure:**
    1. TopAppBar with title "Edit Routines" and back button to /skincare
    2. Day selector — 7 buttons for Monday-Sunday (use DAYS_OF_WEEK from lib/skincare-seed.ts)
    3. Selected day state (useState, default to current day using new Date().getDay())
    4. Placeholder sections for "Morning Routine" and "Night Routine" (just headings for now)
    5. Fetch routines on mount using getRoutines() Server Action
    
    **UI requirements:**
    - Use Tokyo Night design system (existing Card, Button components from @/components/ui)
    - Day selector: horizontal scrollable row of buttons, active day highlighted
    - Convert JavaScript Date.getDay() (0=Sunday) to ISO 8601 (1=Monday, 7=Sunday)
    - Display selected day name prominently (e.g., "Monday's Routine")
    - Use async/await with getRoutines in useEffect or Server Component pattern
    
    **What to avoid:**
    - Don't implement step editing yet — that's Plan 9.2-02
    - Don't use deprecated /skincare/settings page — this is new /routines route
    - Don't forget to import DAYS_OF_WEEK helper from lib/skincare-seed.ts
  </action>
  <verify>curl -s http://localhost:3000/skincare/routines 2>/dev/null | grep -q "Edit Routines" || echo "Start dev server first"</verify>
  <done>Page renders at /skincare/routines with day selector, displays selected day, and fetches routines from database</done>
</task>

<task type="auto">
  <name>Add navigation link from home to Skincare module</name>
  <files>app/page.tsx</files>
  <action>
    Add Skincare module card to home page alongside existing Finance card:
    
    **Requirements:**
    - Add second ModuleCard with title "Skincare", description "Daily routine tracker", href="/skincare/routines"
    - Use existing ModuleCard component pattern from Finance
    - Place after Finance card in the grid
    - Use appropriate icon (e.g., Sparkles or Heart from lucide-react)
    
    **What to avoid:**
    - Don't modify Finance card — only add new Skincare card
    - Don't change grid layout — existing responsive grid handles multiple cards
  </action>
  <verify>grep -q "skincare/routines" app/page.tsx</verify>
  <done>Home page has Skincare module card linking to /skincare/routines</done>
</task>

## Success Criteria

- [ ] Server Actions file created with getRoutines, upsertRoutine, deleteRoutine functions
- [ ] /skincare/routines page renders with TopAppBar and day selector (7 day buttons)
- [ ] Day selector highlights current day by default and updates on click
- [ ] Page fetches and displays routines from database (even if empty)
- [ ] Home page has Skincare module card linking to routine management
- [ ] All code follows established Finance module patterns (Server Actions, Tokyo Night UI)
