---
phase: 9.2
plan: 2
wave: 2
subsystem: skincare-ui
tags: [ui, crud, forms, drag-drop]
depends_on: [9.2-01]
---

# Plan 9.2-02: Routine Step Editor

## Objective

Build the interactive routine editor UI that allows users to add, edit, delete, and reorder steps for morning and night routines on the selected day.

**Why this matters:** This is the core CRUD interface where users manage their daily skincare routines.

## Context

- `.planning/phases/9.2-routine-management-ui/9.2-01-PLAN.md` — Server Actions and day selector foundation
- `app/skincare/routines/actions.ts` — upsertRoutine Server Action for saving changes
- `lib/skincare-seed.ts` — Step structure: {id: string, order: number, text: string}
- `app/finance/wants/components/` — Reference for form patterns and UI components
- `components/ui/` — shadcn/ui components (Button, Input, Card)

## Tasks

<task type="auto">
  <name>Create RoutineEditor component with step list and CRUD operations</name>
  <files>app/skincare/routines/components/RoutineEditor.tsx</files>
  <action>
    Create RoutineEditor component for managing routine steps:
    
    **Component props:**
    - `dayOfWeek: number` — Selected day (1-7)
    - `timeOfDay: 'morning' | 'night'` — Which routine to edit
    - `initialSteps: Array<{id: string, order: number, text: string}>` — Existing steps from database
    
    **State management:**
    - Local state for steps array (useState with initialSteps)
    - New step input field (controlled input)
    - Editing state for inline editing of existing steps
    
    **CRUD operations:**
    1. **Add step:** Input field + "Add Step" button → append to steps array with new UUID and next order number
    2. **Edit step:** Click step text → inline input → save on blur/enter
    3. **Delete step:** Delete button (X icon) next to each step → remove from array
    4. **Reorder steps:** Up/Down arrow buttons → swap order values and re-sort
    5. **Save to database:** "Save Routine" button → call upsertRoutine Server Action with current steps
    
    **UI structure:**
    - Card wrapper with timeOfDay as heading ("Morning Routine" / "Night Routine")
    - Ordered list of steps with order numbers (1, 2, 3...)
    - Each step: order number, text, edit button, delete button, up/down arrows
    - Add step input at bottom
    - Save button at bottom (primary button, disabled if no changes)
    
    **What to avoid:**
    - Don't use drag-and-drop libraries — simple up/down buttons are sufficient
    - Don't auto-save on every change — explicit "Save Routine" button for user control
    - Don't mutate steps array directly — use immutable updates (map, filter)
    - Don't forget to re-sort steps by order after reordering
  </action>
  <verify>grep -q "RoutineEditor" app/skincare/routines/components/RoutineEditor.tsx</verify>
  <done>RoutineEditor component exists with add, edit, delete, reorder, and save functionality</done>
</task>

<task type="auto">
  <name>Integrate RoutineEditor into routines page</name>
  <files>app/skincare/routines/page.tsx</files>
  <action>
    Update the routines page to render RoutineEditor components:
    
    **Changes:**
    1. Import RoutineEditor component
    2. Replace placeholder "Morning Routine" and "Night Routine" headings with RoutineEditor components
    3. Pass selectedDay, timeOfDay, and fetched steps as props
    4. Filter fetched routines by selectedDay and timeOfDay to get initialSteps
    5. Handle empty routines (no steps) — RoutineEditor should handle gracefully with empty array
    
    **Layout:**
    - Two RoutineEditor components stacked vertically
    - Morning routine first, night routine second
    - Adequate spacing between them (gap-6 or similar)
    
    **Data flow:**
    - Fetch routines on mount and when selectedDay changes
    - Extract morning steps: routines.find(r => r.day_of_week === selectedDay && r.time_of_day === 'morning')?.steps || []
    - Extract night steps: routines.find(r => r.day_of_week === selectedDay && r.time_of_day === 'night')?.steps || []
    
    **What to avoid:**
    - Don't refetch routines on every render — use useEffect with selectedDay dependency
    - Don't forget to handle loading state while fetching
  </action>
  <verify>grep -q "RoutineEditor" app/skincare/routines/page.tsx</verify>
  <done>Page renders two RoutineEditor components (morning and night) with data from database</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify routine editing workflow end-to-end</name>
  <files>N/A</files>
  <action>
    **Manual verification steps:**
    
    1. Navigate to home page → click Skincare card → arrives at /skincare/routines
    2. Verify day selector shows all 7 days, current day is highlighted
    3. Click different days → verify morning/night sections update
    4. **Add steps:**
       - Type "Cleanser" in morning routine input → click Add Step
       - Verify step appears in list with order number 1
       - Add 2 more steps → verify order numbers increment (1, 2, 3)
    5. **Edit step:**
       - Click step text → verify inline input appears
       - Change text → press Enter → verify text updates
    6. **Reorder steps:**
       - Click down arrow on step 1 → verify it swaps with step 2
       - Click up arrow on step 2 → verify it swaps back
    7. **Delete step:**
       - Click delete (X) button on step 3 → verify it disappears
       - Verify remaining steps renumber correctly
    8. **Save routine:**
       - Click "Save Routine" button
       - Refresh page → verify steps persist
       - Switch to different day and back → verify steps still there
    9. **Night routine:**
       - Repeat add/edit/delete/reorder/save for night routine
       - Verify both morning and night routines save independently
    
    **Expected behavior:**
    - All CRUD operations work smoothly
    - No console errors
    - Data persists across page refreshes
    - UI follows Tokyo Night design system
  </action>
  <verify>echo "Human verification required"</verify>
  <done>User confirms all CRUD operations work correctly and data persists</done>
</task>

## Success Criteria

- [ ] RoutineEditor component created with add, edit, delete, reorder, save functionality
- [ ] /skincare/routines page renders two RoutineEditor components (morning and night)
- [ ] Users can add new steps with auto-incrementing order numbers
- [ ] Users can edit step text inline
- [ ] Users can delete steps with confirmation
- [ ] Users can reorder steps using up/down arrows
- [ ] "Save Routine" button calls upsertRoutine Server Action
- [ ] Saved routines persist across page refreshes and day switches
- [ ] UI follows Tokyo Night design system with Card, Button, Input components
- [ ] Manual verification confirms end-to-end workflow works correctly
