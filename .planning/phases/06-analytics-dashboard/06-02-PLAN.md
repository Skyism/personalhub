---
phase: 06-analytics-dashboard
plan: 02
type: execute
---

<objective>
Create spending trends over time and budget vs actual comparison charts.

Purpose: Show spending patterns over time and highlight budget adherence across categories.
Output: Line chart for spending trends, bar chart for budget vs actual comparison.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-dashboard/06-01-SUMMARY.md
@.planning/phases/04-transaction-system/04-01-SUMMARY.md
@app/finance/budgets/[id]/page.tsx
@components/charts/ChartWrapper.tsx

**Tech stack available:** Next.js 16.1.1, TypeScript, Tailwind, Recharts 2.12.0, Supabase

**Established patterns:**
- ChartWrapper with ResponsiveContainer (from 06-01)
- Client Components for charts with 'use client'
- Server Components fetch and aggregate data
- Currency formatting helper functions

**Constraining decisions:**
- Phase 06-01: ChartWrapper pattern established for responsive charts
- Phase 04-01: Transaction list grouped by date, categorySpending calculated
- Transactions have transaction_date field (YYYY-MM-DD format)
- Categories have allocated_amount in category_allocations table

**Current state:**
- ChartWrapper component available for responsive charts
- Transaction data with dates and amounts available
- Category allocations with budget amounts available
- Need time-series aggregation and comparison visualization
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create spending trends over time line chart</name>
  <files>components/charts/SpendingTrendsChart.tsx</files>
  <action>
Create Client Component at `components/charts/SpendingTrendsChart.tsx`:
- 'use client' directive
- Import LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend from recharts
- Import ChartWrapper from ./ChartWrapper

Props interface:
```typescript
type DailySpending = {
  date: string // YYYY-MM-DD format
  amount: number
  formattedDate: string // "Jan 12" format for display
}
type SpendingTrendsChartProps = {
  data: DailySpending[]
  budgetTotal?: number // optional line showing daily budget limit
}
```

Implementation:
1. If no data, show empty state: "No transactions yet"
2. Sort data by date ascending for chronological display
3. Use LineChart with:
   - Line component: dataKey="amount", stroke="#3B82F6" (blue-500), strokeWidth={2}
   - XAxis: dataKey="formattedDate", angle={-45}, textAnchor="end", height={60} (angled labels for mobile)
   - YAxis: tickFormatter for currency (e.g., "$50"), width={60}
   - CartesianGrid: strokeDasharray="3 3" for subtle grid
   - Tooltip: formatter for currency, label shows full date
   - If budgetTotal provided: Add ReferenceLine at y={budgetTotal / 30} (daily budget line) with label="Daily Budget"

Tooltip formatter:
```typescript
const formatCurrency = (value: number) =>
  new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value)
```

Mobile optimization:
- Use tick={{ fontSize: 12 }} on XAxis for smaller labels on mobile
- Limit XAxis ticks with interval="preserveStartEnd" to avoid crowding

Wrap in ChartWrapper with height={300}.
  </action>
  <verify>Component exports, has 'use client', renders line chart with dates on X-axis and amounts on Y-axis, handles empty state</verify>
  <done>Spending trends line chart renders with time series data, formatted currency, angled date labels, optional budget line, responsive sizing</done>
</task>

<task type="auto">
  <name>Task 2: Create budget vs actual comparison bar chart</name>
  <files>components/charts/BudgetComparisonChart.tsx</files>
  <action>
Create Client Component at `components/charts/BudgetComparisonChart.tsx`:
- 'use client' directive
- Import BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, Cell from recharts
- Import ChartWrapper from ./ChartWrapper

Props interface:
```typescript
type CategoryComparison = {
  category: string
  budgeted: number // allocated_amount
  spent: number // actual spending
  color: string | null // category color
}
type BudgetComparisonChartProps = {
  data: CategoryComparison[]
}
```

Implementation:
1. If no data, show empty state: "No budget allocations yet"
2. Sort data by budgeted amount descending (highest budget first)
3. Use BarChart with layout="vertical" (horizontal bars for better mobile readability):
   - XAxis type="number", tickFormatter for currency
   - YAxis type="category", dataKey="category", width={100} (accommodate category names)
   - Bar dataKey="budgeted": fill="#E5E7EB" (gray-200), label="Budgeted"
   - Bar dataKey="spent": Use Cell with conditional colors:
     - If spent > budgeted: fill="#EF4444" (red-500) - over budget
     - If spent >= budgeted * 0.8: fill="#F59E0B" (yellow-500) - nearing limit
     - Else: fill="#10B981" (green-500) - healthy
   - Tooltip: Show category, budgeted, spent, and percentage used
   - Legend: positioned top with "Budgeted" and "Spent" labels

Tooltip content:
```typescript
<TooltipContent>
  {category}: {formatCurrency(spent)} / {formatCurrency(budgeted)}
  ({(spent / budgeted * 100).toFixed(0)}%)
</TooltipContent>
```

Mobile optimization:
- Use horizontal bars (layout="vertical") so category names aren't cramped
- Set barSize={20} for consistent bar thickness
- Truncate long category names with CSS if needed

Wrap in ChartWrapper with height={Math.max(300, data.length * 60)} (dynamic height based on category count, minimum 300px).
  </action>
  <verify>Component exports, has 'use client', renders horizontal bar chart with budgeted vs spent, conditional colors for over-budget categories</verify>
  <done>Budget comparison chart renders with horizontal bars, color-coded spending status (green/yellow/red), currency formatting, dynamic height for all categories</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Spending trends line chart and budget vs actual comparison bar chart with Recharts</what-built>
  <how-to-verify>
1. Start dev server: npm run dev

2. Navigate to budget with transactions:
   - Visit: http://localhost:3000/finance/budgets
   - Click on a budget with multiple transactions across different dates

3. Temporarily add charts to budget detail page for testing:
   - Open: app/finance/budgets/[id]/page.tsx
   - Add imports at top:
   ```tsx
   import SpendingTrendsChart from '@/components/charts/SpendingTrendsChart'
   import BudgetComparisonChart from '@/components/charts/BudgetComparisonChart'
   ```
   - After category spending chart section, add:
   ```tsx
   {/* Spending Trends */}
   <div className="bg-white rounded-lg shadow p-6 mt-6">
     <h2 className="text-2xl font-bold text-gray-900 mb-6">Spending Trends</h2>
     <SpendingTrendsChart
       data={transactions?.map(t => ({
         date: t.transaction_date,
         amount: t.amount,
         formattedDate: new Date(t.transaction_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
       })).reduce((acc, curr) => {
         const existing = acc.find(item => item.date === curr.date)
         if (existing) {
           existing.amount += curr.amount
         } else {
           acc.push(curr)
         }
         return acc
       }, [] as any[]) || []}
       budgetTotal={budget.total_budget}
     />
   </div>

   {/* Budget Comparison */}
   <div className="bg-white rounded-lg shadow p-6 mt-6">
     <h2 className="text-2xl font-bold text-gray-900 mb-6">Budget vs Actual</h2>
     <BudgetComparisonChart
       data={categoryBreakdown.map(cat => ({
         category: cat.name,
         budgeted: cat.allocated,
         spent: cat.spent,
         color: cat.color
       }))}
     />
   </div>
   ```
   - Save and refresh

4. Verify Spending Trends chart:
   - X-axis shows dates in chronological order (e.g., "Jan 12", "Jan 13")
   - Y-axis shows currency amounts (e.g., "$0", "$50", "$100")
   - Blue line connects daily spending totals
   - If budget total provided: Gray dashed line shows daily budget limit
   - Hover tooltip shows date and total amount for that day
   - Angled date labels don't overlap on mobile
   - Chart adjusts to container width

5. Verify Budget Comparison chart:
   - Horizontal bars (category names on left, amounts on right)
   - Each category has two bars: gray (budgeted) and colored (spent)
   - Color coding:
     - Green bars: Spending healthy (< 80% of budget)
     - Yellow bars: Nearing budget (80-100%)
     - Red bars: Over budget (> 100%)
   - Hover tooltip shows category, budgeted amount, spent amount, and percentage
   - All category names visible without truncation
   - Chart height adjusts based on number of categories

6. Test responsive behavior:
   - Desktop: Verify charts are well-sized, labels readable
   - Mobile (< 768px): Verify angled labels on trends chart, horizontal bars on comparison chart
   - Resize browser: Verify charts adjust smoothly

7. Test edge cases:
   - Budget with one transaction: Trends chart shows single point
   - Budget with no allocations: Comparison chart shows empty state
   - Category over budget: Comparison chart shows red bar exceeding gray bar

8. After verification, REMOVE the temporary chart additions from page.tsx (we'll add them properly in Plan 3)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SpendingTrendsChart component exists with LineChart
- [ ] BudgetComparisonChart component exists with BarChart
- [ ] Trends chart renders with time series data and optional budget line
- [ ] Comparison chart renders with color-coded bars (green/yellow/red)
- [ ] Both charts responsive and mobile-friendly
- [ ] Empty states handle no data gracefully
- [ ] npm run build succeeds without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Spending trends line chart functional with time series
- Budget vs actual bar chart functional with color coding
- Both charts responsive and mobile-optimized
- Ready for Plan 3 (dashboard page integration)
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-dashboard/06-02-SUMMARY.md`:

# Phase 6 Plan 2: Spending Trends and Budget Comparison Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 06-03-PLAN.md (Analytics dashboard page integration and mobile polish)
</output>
