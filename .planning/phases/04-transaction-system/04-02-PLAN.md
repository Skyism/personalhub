---
phase: 04-transaction-system
plan: 02
type: execute
---

<objective>
Implement manual transaction entry form with category selection and CRUD operations.

Purpose: Enable users to manually log expenses with category assignment, notes, and custom dates.
Output: Working transaction entry form with Server Actions for create and delete, integrated into budget detail page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-transaction-system/04-01-SUMMARY.md
@app/finance/budgets/[id]/page.tsx
@app/finance/budgets/actions.ts
@app/finance/categories/actions.ts
@lib/database.types.ts
@lib/supabase/server.ts

**Tech stack available:** @supabase/supabase-js@2.90.1, @supabase/ssr@0.8.0, Next.js App Router, TypeScript, Tailwind CSS

**Established patterns:**
- Server Components for data fetching
- Client Components for forms and interactivity
- Server Actions for mutations with validation and revalidation
- Hardcoded TEMP_USER_ID for development
- Toggle-based forms (collapsed by default, expand on click)
- Mobile-first Tailwind styling

**Constraining decisions:**
- Phase 02-02: Transactions table has amount (numeric), category_id (nullable), note (nullable), source ('manual' or 'sms'), transaction_date (timestamptz), budget_id (required)
- Phase 03-01: Server Actions pattern with revalidatePath for optimistic updates
- Phase 03-02: Inline edit/delete UI pattern, form validation in Server Actions

**Issues being addressed:** None

**From Plan 04-01:** Transaction display infrastructure is complete, showing transaction list and spending summary
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transaction entry form</name>
  <files>app/finance/budgets/[id]/TransactionForm.tsx, app/finance/budgets/[id]/page.tsx</files>
  <action>
Create TransactionForm.tsx as a Client Component ('use client') with:
- Amount input (type="number", step="0.01", min="0", required) - enforce positive amounts
- Category dropdown (select) - fetch categories for current user, include "Uncategorized" option (null value)
- Note input (textarea, optional, max 500 chars)
- Date input (type="date", defaults to today)
- Submit button ("Add Transaction")

Use toggle pattern from Phase 3: Form collapsed by default, "Add Transaction" button expands form. Close form after successful submission.

Validation:
- Client-side: Amount must be > 0, date cannot be future
- Show validation errors inline with red text
- Disable submit during loading (prevent double-submit)

Pass budget_id as prop from parent Server Component. On submit, call Server Action with form data.

Integrate into budget detail page (app/finance/budgets/[id]/page.tsx) ABOVE the transaction list, BELOW spending summary. Pass current budget.id as prop.

DO NOT add edit functionality yet - only create and delete. Use 'manual' as source value (hardcoded, not user input).
  </action>
  <verify>npm run build succeeds, form renders with all fields, validation works client-side</verify>
  <done>Transaction form displays correctly, all fields present, toggle behavior works, validation prevents invalid submissions</done>
</task>

<task type="auto">
  <name>Task 2: Implement transaction Server Actions</name>
  <files>app/finance/budgets/transactions/actions.ts</files>
  <action>
Create Server Actions file with two actions:

1. createTransaction(formData: FormData, budgetId: number)
   - Extract: amount, category_id (parse as int or null), note, transaction_date
   - Validate: amount > 0, date not in future, budget_id exists for TEMP_USER_ID
   - Insert into transactions table with: amount, category_id, note, transaction_date, budget_id, user_id (TEMP_USER_ID), source='manual'
   - Use revalidatePath(`/finance/budgets/${budgetId}`) to refresh page
   - Return success/error with message

2. deleteTransaction(transactionId: number, budgetId: number)
   - Validate: transaction exists and belongs to TEMP_USER_ID
   - Delete from transactions table
   - Use revalidatePath(`/finance/budgets/${budgetId}`)
   - Return success/error

Add delete buttons to transaction list items in page.tsx (inline delete button, red text, confirms before deletion). Use Client Component pattern if needed for delete confirmation.

Follow existing Server Action patterns from app/finance/budgets/actions.ts (error handling, revalidation, return types).

DO NOT implement edit functionality - that's a future enhancement. DO NOT validate against category allocations (no over-budget warnings yet - that's Phase 6 analytics).
  </action>
  <verify>curl tests to Server Actions would work, but test via UI in next task</verify>
  <done>Server Actions created with validation, createTransaction inserts correctly, deleteTransaction removes records, revalidation refreshes UI</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Transaction CRUD with form entry and delete functionality</what-built>
  <how-to-verify>
1. Run: npm run dev
2. Visit: http://localhost:3000/finance/budgets
3. Click on any budget to view detail page
4. Test transaction creation:
   - Click "Add Transaction" to expand form
   - Enter amount: 25.50
   - Select a category (or leave Uncategorized)
   - Add note: "Test transaction"
   - Submit form
   - Verify: Transaction appears in list below, spending summary updates
5. Test validation:
   - Try negative amount - should show error
   - Try future date - should show error
   - Try empty amount - should show error
6. Test multiple transactions:
   - Add 2-3 more transactions with different categories
   - Verify: All appear in list, spending summary calculates correctly
   - Verify: Per-category spent amounts update
7. Test deletion:
   - Click delete button on a transaction
   - Confirm deletion (if confirmation dialog present)
   - Verify: Transaction removed, spending summary recalculates
8. Test edge cases:
   - Add uncategorized transaction - verify it shows "Uncategorized" badge
   - Add transaction with no note - verify it displays without error
9. Mobile responsive:
   - Resize to mobile width
   - Verify: Form layout adapts, transaction list remains readable
10. Confirm: No console errors, TypeScript builds cleanly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] Transaction form creates new transactions successfully
- [ ] Validation prevents invalid data (negative amounts, future dates)
- [ ] Delete functionality removes transactions
- [ ] Spending summary recalculates after create/delete
- [ ] Per-category breakdowns update correctly
- [ ] Mobile responsive layout works
- [ ] No TypeScript errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Phase 4 complete - manual transaction entry fully functional
- Ready for Phase 5 (SMS Integration)
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-transaction-system/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Manual Transaction Entry Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete. Ready for Phase 5 (SMS Integration) - `/gsd:plan-phase 5`
</output>
