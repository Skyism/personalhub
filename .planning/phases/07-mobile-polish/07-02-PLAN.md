---
phase: 07-mobile-polish
plan: 02
type: execute
---

<objective>
Optimize mobile performance with Suspense boundaries, loading skeletons, and enhanced error handling for slow network conditions.

Purpose: Mobile users often experience variable network conditions (3G, weak LTE, subway). Implement loading states and error boundaries that provide feedback during slow loads and gracefully handle failures.
Output: Performance-optimized mobile experience with React Suspense, loading.tsx files, error boundaries, and skeleton screens.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mobile-polish/07-01-SUMMARY.md

**Tech stack available:**
- Next.js 16 App Router with Suspense support
- React 19.2 with Suspense boundaries
- Server Components with streaming SSR
- Tailwind CSS v4 for styling

**Established patterns:**
- Server Components for data fetching
- Client Components for interactivity
- Supabase queries in Server Components

**Key files:**
@app/finance/budgets/page.tsx
@app/finance/budgets/[id]/page.tsx
@app/finance/analytics/page.tsx

**Current performance state:**
- No loading states during Server Component data fetches
- No error boundaries for failed queries
- Charts load synchronously (could be split)
- No skeleton screens during initial page load

**Issues being addressed:**
- Blank screens during slow data fetches on mobile networks
- No user feedback when Supabase queries are slow
- Poor UX on network failures (no error boundaries)
- Charts loading could be deferred for faster initial render
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loading.tsx files for route segments</name>
  <files>app/finance/budgets/loading.tsx, app/finance/budgets/[id]/loading.tsx, app/finance/analytics/loading.tsx</files>
  <action>
  Create loading.tsx files for each route that fetches data from Supabase. Next.js automatically wraps the page in Suspense and shows loading.tsx during data fetch.

  1. app/finance/budgets/loading.tsx:
     - Skeleton for budget list page
     - Show 3 skeleton cards (gray animated pulse rectangles)
     - Match layout of actual budget cards (rounded-lg, shadow, p-6)
     - Use animate-pulse for shimmer effect

  2. app/finance/budgets/[id]/loading.tsx:
     - Skeleton for budget detail page
     - Header skeleton (title + budget amount)
     - Spending summary skeleton (progress bar + stats)
     - Category breakdown skeleton (3-4 category cards)
     - Transaction list skeleton (5 transaction items)
     - Match actual layout structure

  3. app/finance/analytics/loading.tsx:
     - Skeleton for analytics dashboard
     - Three chart card skeletons in grid layout
     - Match responsive grid (grid-cols-1 lg:grid-cols-2)
     - Budget selector skeleton at top

  Use Tailwind's animate-pulse utility for shimmer effect.
  Avoid overly detailed skeletons - simple rectangles with proper spacing is sufficient.
  </action>
  <verify>Visit each route with network throttling (DevTools: Fast 3G), verify loading.tsx appears during data fetch, then real content replaces it</verify>
  <done>Three loading.tsx files created with skeleton screens, Next.js automatically shows them during Suspense, transitions to real content when ready, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Add error boundaries for data fetching failures</name>
  <files>app/finance/budgets/error.tsx, app/finance/budgets/[id]/error.tsx, app/finance/analytics/error.tsx</files>
  <action>
  Create error.tsx files for each route to handle Supabase query failures. Next.js automatically catches errors in Server Components and shows error.tsx with recovery options.

  1. app/finance/budgets/error.tsx:
     - "use client" directive required for error boundaries
     - Accept error and reset props
     - Display error message: "Failed to load budgets"
     - Show "Try Again" button that calls reset()
     - Show "Go Home" link to /finance
     - Use red accent colors (bg-red-50, text-red-600)
     - Include error details in development mode only (process.env.NODE_ENV)

  2. app/finance/budgets/[id]/error.tsx:
     - Similar structure to budgets error
     - Message: "Failed to load budget details"
     - Include "Back to Budgets" link

  3. app/finance/analytics/error.tsx:
     - Message: "Failed to load analytics"
     - Include "Back to Budgets" link
     - Show error details in dev mode

  Pattern: All error boundaries should be Client Components with reset function and navigation options.
  Avoid exposing sensitive error details in production - use generic messages for users, log details server-side.
  </action>
  <verify>Temporarily break a Supabase query (invalid table name), verify error.tsx appears with message and retry button, fix query and verify retry works</verify>
  <done>Three error.tsx files created with error boundaries, "Try Again" functionality works, error details hidden in production, TypeScript compiles without errors</done>
</task>

<task type="auto">
  <name>Task 3: Optimize chart loading with dynamic imports</name>
  <files>components/charts/CategorySpendingChart.tsx, components/charts/SpendingTrendsChart.tsx, components/charts/BudgetComparisonChart.tsx</files>
  <action>
  Charts using Recharts are heavy dependencies (~100KB gzipped). Defer loading until needed using React.lazy() or Next.js dynamic imports to improve initial page load on mobile.

  1. Update chart component exports to be compatible with dynamic loading:
     - Ensure all three chart components have proper default exports
     - Wrap in Suspense-compatible structure

  2. In app/finance/analytics/page.tsx:
     - Import charts using next/dynamic with { ssr: false, loading: () => skeleton }
     - Add loading prop that shows simple skeleton div during chart load
     - Example: `const CategorySpendingChart = dynamic(() => import('@/components/charts/CategorySpendingChart'), { ssr: false, loading: () => <ChartSkeleton /> })`
     - This defers chart JavaScript download until analytics page is visited

  3. Create simple ChartSkeleton component in analytics/page.tsx:
     - Gray rounded rectangle with animate-pulse
     - Height matches actual chart (h-[300px])

  Why this matters: Initial page load improves by 100KB+ on mobile networks. Charts only load when user navigates to analytics.
  Avoid ssr: true for charts - Recharts doesn't support SSR well and causes hydration mismatches.
  </action>
  <verify>Run npm run build, check bundle size for analytics route, verify chart components are in separate chunks, visit analytics page and verify charts load after initial render</verify>
  <done>Charts use dynamic imports with { ssr: false }, loading skeletons appear during chart load, bundle analyzer shows separate chunks for each chart, build passes with no hydration warnings</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without errors
- [ ] npm run lint passes
- [ ] All routes have loading.tsx files that appear during data fetch
- [ ] All routes have error.tsx files that catch failures
- [ ] Charts load dynamically with loading skeletons
- [ ] Network throttling (Fast 3G) shows loading states appropriately
- [ ] Error boundaries work when queries fail
- [ ] Bundle size reduced by code splitting charts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Loading.tsx files show during slow data fetches
- Error.tsx boundaries catch and display failures gracefully
- Charts load dynamically to reduce initial bundle size
- No TypeScript errors
- No hydration mismatches
- Mobile experience feels responsive even on slow networks
  </success_criteria>

<output>
After completion, create `.planning/phases/07-mobile-polish/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Performance and Loading Optimization Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [List key outcomes]

## Files Created/Modified

- `file.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 7 complete - all mobile optimizations implemented. Ready for Phase 8: UI Overhaul.
</output>
