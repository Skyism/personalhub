---
phase: 03-budget-management
plan: 02
type: execute
---

<objective>
Build category management UI and integrate category budget allocation within budget detail view.

Purpose: Enable users to define spending categories and allocate portions of their monthly budget to each category.
Output: Category CRUD interface and budget-category allocation UI integrated into budget detail page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-budget-management/03-01-SUMMARY.md
@lib/supabase/client.ts
@lib/supabase/server.ts
@lib/database.types.ts
@app/finance/budgets/page.tsx
@app/finance/budgets/[id]/page.tsx

**Tech stack available:**
- Next.js App Router with TypeScript
- Tailwind CSS for styling (including color utilities)
- Supabase client utilities (browser + server)
- Database schema: budgets, categories, transactions tables
- Budget UI from Plan 1 (list, detail, create)

**Established patterns:**
- Server Components for data fetching, Client Components for interactivity
- Server Actions for mutations (createBudget pattern from Plan 1)
- Mobile-first responsive design
- Hardcoded user_id with TODO comments for auth

**Database schema (categories table):**
```typescript
{
  id: number
  user_id: string
  name: string
  color: string | null // hex color for UI (e.g., "#3B82F6")
  created_at: string | null
}
```

**Key constraint from PROJECT.md:**
"Budget management supporting both total monthly budget and per-category budgets"
- Categories are user-defined and reusable across months
- Each category can have a budget allocation within a specific monthly budget
- Plan 1 established total monthly budgets; Plan 2 adds per-category allocations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create categories management page</name>
  <files>app/finance/categories/page.tsx, app/finance/categories/actions.ts</files>
  <action>
    Create category management interface:

    1. Create app/finance/categories/page.tsx as Server Component:
       - Fetch all categories for current user using server Supabase client
       - Display categories in a grid/list with name and color indicator (colored badge/dot)
       - Each category shows: name, color preview, edit/delete buttons
       - "Create Category" button at top
       - Empty state if no categories exist
       - Mobile-first responsive grid

    2. Create app/finance/categories/actions.ts with Server Actions:
       - createCategory(name: string, color: string | null)
       - updateCategory(id: number, name: string, color: string | null)
       - deleteCategory(id: number)
       - All use server Supabase client with hardcoded user_id (TODO for auth)
       - Return { success: boolean, error?: string } for each

    3. Add inline edit/delete functionality using Client Component islands:
       - Create a simple CategoryCard client component that handles edit/delete clicks
       - Edit opens an inline form or modal with name and color picker inputs
       - Delete shows confirmation and calls deleteCategory action
       - Use Tailwind color classes for color picker (predefined palette like blue-500, green-500, red-500, etc.)

    Add link to /finance/categories from the finance module landing page or from budget detail view breadcrumb/nav.
  </action>
  <verify>
    1. Visit /finance/categories shows empty state
    2. Create a category (name: "Food", color: "#10B981")
    3. Category appears in list with green color indicator
    4. Edit category name works
    5. Delete category shows confirmation and removes from list
    6. TypeScript compilation passes
  </verify>
  <done>Category management page functional with create, edit, delete operations working, colors displaying correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add category budget allocation to budget detail view</name>
  <files>app/finance/budgets/[id]/page.tsx, app/finance/budgets/[id]/CategoryAllocation.tsx, app/finance/budgets/category-allocations/actions.ts</files>
  <action>
    Integrate category budget allocation into budget detail page:

    1. Create a new table: category_allocations (via migration):
       - id (generated identity)
       - budget_id (foreign key to budgets, on delete cascade)
       - category_id (foreign key to categories, on delete cascade)
       - allocated_amount (numeric(10,2))
       - user_id (for RLS)
       - Unique constraint on (budget_id, category_id) - one allocation per category per budget
       - 4 RLS policies (select/insert/update/delete where user_id = auth.uid())

    Since this is a schema change, create migration file: supabase/migrations/[timestamp]_create_category_allocations.sql
    Apply it using Supabase MCP tools (mcp__plugin_supabase_supabase__apply_migration)
    Regenerate TypeScript types after applying migration

    2. Update app/finance/budgets/[id]/page.tsx:
       - Fetch budget with category allocations
       - Show category allocation section below budget info
       - Display total allocated vs. total budget (e.g., "$800 / $1000 allocated")
       - List each category with its allocation amount
       - Include "Add Category Allocation" button

    3. Create app/finance/budgets/[id]/CategoryAllocation.tsx as Client Component:
       - Dropdown to select category (populated from user's categories)
       - Input for allocation amount
       - Submit calls Server Action to create/update allocation
       - Shows validation: allocated total cannot exceed budget total

    4. Create app/finance/budgets/category-allocations/actions.ts:
       - setAllocation(budgetId: number, categoryId: number, amount: number)
       - removeAllocation(budgetId: number, categoryId: number)
       - Validation: sum of allocations for budget must not exceed budget.total_budget
       - Use server Supabase client with hardcoded user_id

    This enables users to break down their monthly budget into category-specific allocations (e.g., $1000 total â†’ $300 Food, $200 Transport, $500 Other).
  </action>
  <verify>
    1. Visit budget detail page, see "Category Allocations" section
    2. Add allocation: select category, enter amount, submit
    3. Allocation appears in list
    4. Total allocated updates correctly
    5. Validation prevents over-allocation (try allocating more than budget total)
    6. Remove allocation works
    7. Check database to confirm category_allocations table populated
    8. TypeScript compilation passes with new types
  </verify>
  <done>Category allocation UI integrated into budget detail view, allocations stored in database, validation working, types updated</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Budget Management UI with categories and allocations</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/finance/budgets
    3. Test budget creation flow:
       - Click "Create Budget"
       - Enter month (e.g., 2026-01) and total budget (e.g., 1500.00)
       - Submit and verify redirect to budget list
    4. Test category management:
       - Navigate to /finance/categories
       - Create 3 categories: "Food" (green), "Transport" (blue), "Entertainment" (purple)
       - Edit a category name
       - Verify colors display correctly as badges/indicators
    5. Test category allocation:
       - Go to budget detail page (click budget from list)
       - Add category allocations: Food ($500), Transport ($300), Entertainment ($200)
       - Verify total allocated shows "$1000 / $1500"
       - Try over-allocating (enter $1000 for Entertainment) - should show validation error
       - Remove an allocation and verify it disappears
    6. Mobile responsiveness:
       - Resize browser to mobile width (375px)
       - Verify all pages remain usable (forms, lists, buttons accessible)
       - Check touch targets are adequately sized
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] Category management page works (create, edit, delete)
- [ ] Category allocations integrated into budget detail view
- [ ] Allocation validation prevents over-budget allocation
- [ ] Migration applied successfully
- [ ] TypeScript types updated and compilation passes
- [ ] Mobile responsive design maintained
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Users can create and manage categories with colors
- Users can allocate portions of budget to categories
- Validation ensures allocations don't exceed budget total
- Budget detail view shows allocated vs. total amounts
- Mobile-first responsive design throughout
- Phase 3 complete: Budget Management fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-budget-management/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Category Management - Summary

**[One-liner about what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3 complete. Ready for Phase 4 (Transaction System).
</output>
