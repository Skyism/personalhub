---
phase: 8.1-semi-annual-wants-budget
plan: 01
type: execute
---

<objective>
Create database schema for semi-annual wants budget tracking with separate periods (Jan-Jun, Jul-Dec) and transaction tables.

Purpose: Establish the database foundation for tracking wants spending outside the monthly budget system, with 6-month budget periods and full transaction history.
Output: Wants budget tables with RLS policies, TypeScript types, and period management structure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-supabase-backend/02-02-SUMMARY.md
@.planning/phases/05-sms-integration/05-01-SUMMARY.md
@supabase/migrations/20260111_create_finance_schema.sql
@lib/database.types.ts

**Tech stack available:**
- Supabase client utilities (Phase 2)
- Supabase MCP tools for migrations (Phase 2)
- Established Finance schema: budgets, categories, transactions tables (Phase 2)
- Twilio SMS integration patterns (Phase 5)

**Established patterns:**
- Row Level Security with TEMP_USER_ID workaround (Phase 2)
- Supabase migrations via MCP tool (Phase 2, 9, 11)
- numeric(10,2) for currency amounts (Phase 2)
- timestamptz for timestamps (Phase 2)
- source column pattern ('manual'/'sms') for tracking entry method (Phase 2)
- twilio_message_id for SMS idempotency (Phase 5)
- Generated identity columns for primary keys (Phase 2)
- Foreign key indexing for performance (Phase 2)

**Constraining decisions:**
- Phase 2: Single-user app with RLS using TEMP_USER_ID until auth implemented
- Phase 2: Nullable category_id allows uncategorized transactions
- Phase 5: Twilio idempotency via unique twilio_message_id constraint
- Phase 8.1 Requirements: Semi-annual periods (Jan-Jun, Jul-Dec), separate from monthly budgets, full CRUD support

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wants budget database schema migration</name>
  <files>supabase/migrations/20260115_create_wants_schema.sql, lib/database.types.ts</files>
  <action>
Create database migration for wants budget system with two tables:

**Table 1: wants_budgets**
- id: bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY
- user_id: uuid NOT NULL (FK to auth.users, but use TEMP_USER_ID for now)
- period_start: date NOT NULL (e.g., '2026-01-01', '2026-07-01')
- period_end: date NOT NULL (e.g., '2026-06-30', '2026-12-31')
- total_amount: numeric(10,2) NOT NULL CHECK (total_amount > 0)
- created_at: timestamptz DEFAULT now()
- updated_at: timestamptz DEFAULT now()
- UNIQUE constraint on (user_id, period_start)
- Index on user_id

**Table 2: wants_transactions**
- id: bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY
- user_id: uuid NOT NULL
- wants_budget_id: bigint NOT NULL (FK to wants_budgets ON DELETE CASCADE)
- amount: numeric(10,2) NOT NULL
- note: text
- transaction_date: date DEFAULT CURRENT_DATE
- source: text NOT NULL DEFAULT 'manual' CHECK (source IN ('manual', 'sms'))
- twilio_message_id: text UNIQUE (for SMS idempotency, nullable)
- created_at: timestamptz DEFAULT now()
- updated_at: timestamptz DEFAULT now()
- Index on (user_id, wants_budget_id)
- Index on transaction_date
- Index on twilio_message_id (WHERE twilio_message_id IS NOT NULL)

Enable Row Level Security on both tables. Create RLS policies:
- wants_budgets: SELECT/INSERT/UPDATE/DELETE where user_id = TEMP_USER_ID
- wants_transactions: SELECT/INSERT/UPDATE/DELETE where user_id = TEMP_USER_ID

Apply migration via Supabase MCP tool: mcp__plugin_supabase_supabase__apply_migration with project_id, name "create_wants_schema", and SQL query.

After migration, regenerate TypeScript types via mcp__plugin_supabase_supabase__generate_typescript_types and update lib/database.types.ts.

Avoid adding computed columns or triggers (keep it simple). Avoid using date ranges or tsrange types (standard date columns are sufficient). Avoid cascade deletes from wants_budgets to transactions (use CASCADE for referential integrity).
  </action>
  <verify>npm run build passes without TypeScript errors, Supabase schema includes wants_budgets and wants_transactions tables</verify>
  <done>Migration applied, both tables exist with RLS policies, unique constraints working, TypeScript types updated, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Create period helper utilities for wants budgets</name>
  <files>lib/wants/periods.ts</files>
  <action>
Create TypeScript utility functions for managing semi-annual periods:

```typescript
// lib/wants/periods.ts
export type WantsPeriod = {
  periodStart: string; // ISO date YYYY-MM-DD
  periodEnd: string;   // ISO date YYYY-MM-DD
  label: string;       // e.g., "H1 2026" or "H2 2026"
};

export function getCurrentWantsPeriod(referenceDate: Date = new Date()): WantsPeriod {
  const year = referenceDate.getFullYear();
  const month = referenceDate.getMonth(); // 0-indexed

  if (month >= 0 && month <= 5) {
    // Jan-Jun (H1)
    return {
      periodStart: `${year}-01-01`,
      periodEnd: `${year}-06-30`,
      label: `H1 ${year}`,
    };
  } else {
    // Jul-Dec (H2)
    return {
      periodStart: `${year}-07-01`,
      periodEnd: `${year}-12-31`,
      label: `H2 ${year}`,
    };
  }
}

export function getWantsPeriodForDate(date: Date): WantsPeriod {
  return getCurrentWantsPeriod(date);
}

export function formatPeriodLabel(periodStart: string): string {
  const date = new Date(periodStart + 'T00:00:00');
  const year = date.getFullYear();
  const month = date.getMonth();
  return month === 0 ? `H1 ${year}` : `H2 ${year}`;
}

export function getPeriodBounds(year: number, half: 1 | 2): { start: string; end: string } {
  if (half === 1) {
    return { start: `${year}-01-01`, end: `${year}-06-30` };
  }
  return { start: `${year}-07-01`, end: `${year}-12-31` };
}
```

Provide clear JSDoc comments for each function. Follow existing TypeScript patterns from the codebase (strict mode, explicit types).

Avoid using external date libraries like date-fns (not installed, overkill for simple date operations). Avoid timezone conversion (dates are stored as simple date strings YYYY-MM-DD, no timezone needed).
  </action>
  <verify>npm run build passes, functions return correct period boundaries for sample dates (Jan 15 → H1, Aug 10 → H2)</verify>
  <done>Period helper functions created with type exports, correct H1/H2 detection logic, build passes without errors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] wants_budgets and wants_transactions tables exist in Supabase
- [ ] RLS policies active on both tables
- [ ] UNIQUE constraint on wants_budgets(user_id, period_start) works
- [ ] Period helper functions return correct boundaries for current date
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Database schema matches specification
- TypeScript types regenerated successfully
- Period utilities provide correct H1/H2 detection
- No breaking changes to existing Finance module tables
</success_criteria>

<output>
After completion, create `.planning/phases/8.1-semi-annual-wants-budget/8.1-01-SUMMARY.md`:

# Phase 8.1 Plan 1: Wants Budget Database Schema Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- wants_budgets table for semi-annual period tracking (Jan-Jun, Jul-Dec)
- wants_transactions table with SMS idempotency support
- RLS policies for single-user access
- Period helper utilities for H1/H2 detection and date formatting
- TypeScript types updated for new schema

## Files Created/Modified

- `supabase/migrations/20260115_create_wants_schema.sql` - Wants budget schema
- `lib/database.types.ts` - TypeScript types for new tables
- `lib/wants/periods.ts` - Period management utilities

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 8.1-02-PLAN.md (SMS integration extension for wants transactions)
</output>
