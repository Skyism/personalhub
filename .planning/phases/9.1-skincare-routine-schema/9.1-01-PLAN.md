---
phase: 9.1-skincare-routine-schema
plan: 01
type: execute
---

<objective>
Create database schema for storing weekly skincare routines with morning and night steps for each day (Monday-Sunday).

Purpose: Replace deprecated SMS reminder schema with routine tracker schema that stores customizable routine steps for each day of the week.
Output: Working database schema with skincare_routines table, RLS policies, and TypeScript types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-supabase-backend/02-02-SUMMARY.md
@.planning/phases/09-skincare-schema/09-01-SUMMARY.md
@supabase/migrations/20260115_create_wants_schema.sql

**From Phase 2:** Established Supabase migration patterns, RLS policies, type generation workflow.

**From deprecated Phase 9:** Skincare schema for SMS reminders (skincare_settings, night_messages) exists but is no longer needed. New schema will coexist but serve different purpose.

**From Phase 8.1 (Wants Budget):** Recent schema migration pattern for reference - separate table per feature, JSONB for flexible data.

**Schema requirements (from ROADMAP Phase 9.1):**
- Store routines for 7 days (Monday-Sunday)
- Morning and night routines for each day (14 total routine slots per user)
- Each routine contains list of steps/products
- Support add/edit/delete steps, reorder steps
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skincare routine schema migration</name>
  <files>supabase/migrations/20260119_create_skincare_routine_schema.sql</files>
  <action>
Create new migration file with:

**Table: skincare_routines**
- id: bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY
- user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
- day_of_week: int NOT NULL CHECK (day_of_week BETWEEN 1 AND 7) -- 1=Monday, 7=Sunday (ISO 8601 standard)
- time_of_day: text NOT NULL CHECK (time_of_day IN ('morning', 'night'))
- steps: jsonb NOT NULL DEFAULT '[]'::jsonb -- Array of step objects: [{"order": 1, "text": "Cleanser", "id": "uuid"}]
- created_at: timestamptz NOT NULL DEFAULT now()
- updated_at: timestamptz NOT NULL DEFAULT now()
- UNIQUE(user_id, day_of_week, time_of_day) -- One routine per user per day per time

**Index:**
- CREATE INDEX idx_skincare_routines_user_day ON skincare_routines(user_id, day_of_week);

**RLS:**
- ENABLE ROW LEVEL SECURITY
- 4 policies: SELECT, INSERT, UPDATE, DELETE (all using auth.uid() = user_id)

**Migration naming:** Use timestamp format YYYYMMDD matching existing pattern (20260119)

DON'T reference or modify deprecated skincare_settings/night_messages tables - they coexist for now
DON'T use text[] array - use jsonb for flexibility (allows step metadata like id, order, completed state)
DON'T use separate routine_steps table - keep simple with embedded JSON (easier queries, sufficient for use case)
  </action>
  <verify>
1. Migration file exists at correct path with correct timestamp
2. SQL syntax is valid (no typos in CHECK constraints or table definition)
3. UNIQUE constraint covers (user_id, day_of_week, time_of_day)
4. All 4 RLS policies defined (SELECT, INSERT, UPDATE, DELETE)
  </verify>
  <done>Migration file created with skincare_routines table, index, RLS policies, following established patterns</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and generate TypeScript types</name>
  <files>lib/database.types.ts</files>
  <action>
1. Apply migration to Supabase:
   ```bash
   npx supabase db push
   ```
   This pushes local migration to remote Supabase project

2. Generate updated TypeScript types:
   ```bash
   npx supabase gen types typescript --project-id <project-id> > lib/database.types.ts
   ```
   Get project-id from .env.local (NEXT_PUBLIC_SUPABASE_URL contains it)

3. Verify new types exist:
   - Database['public']['Tables']['skincare_routines'] type
   - Row type includes day_of_week (number), time_of_day (string), steps (Json)

DON'T manually edit database.types.ts - always regenerate from Supabase
DON'T skip type generation - TypeScript compilation will fail without it
DON'T commit if types don't include skincare_routines - indicates migration didn't apply
  </action>
  <verify>
1. `npx supabase db push` succeeds without errors
2. `lib/database.types.ts` updated with SkincareRoutines type
3. `npm run build` succeeds (TypeScript compilation passes)
4. File shows recent modification timestamp
  </verify>
  <done>Migration applied to Supabase, TypeScript types generated and include skincare_routines table definition</done>
</task>

<task type="auto">
  <name>Task 3: Create sample routine data helper (optional seed)</name>
  <files>lib/skincare-seed.ts</files>
  <action>
Create helper file with sample routine data structure for testing (NOT a migration, just reference):

```typescript
// Sample routine structure for testing
export const sampleRoutines = [
  {
    day_of_week: 1, // Monday
    time_of_day: 'morning',
    steps: [
      { id: crypto.randomUUID(), order: 1, text: 'Cleanser' },
      { id: crypto.randomUUID(), order: 2, text: 'Toner' },
      { id: crypto.randomUUID(), order: 3, text: 'Moisturizer' },
      { id: crypto.randomUUID(), order: 4, text: 'Sunscreen' }
    ]
  },
  // ... similar for night and other days
]
```

This provides:
- Example of step structure for UI development
- Reference for order numbering (1-indexed)
- UUID pattern for step IDs (used for React keys and potential step-level operations)

DON'T insert this data automatically - it's just a reference for Phase 9.2 UI development
DON'T make this a required part of the schema - users will create their own routines
DON'T overcomplicate - simple array of step objects is sufficient
  </action>
  <verify>
1. File compiles without TypeScript errors
2. Sample data matches schema structure (day_of_week 1-7, time_of_day morning/night, steps as array)
3. File is in lib/ directory for easy import during UI development
  </verify>
  <done>Sample data helper created as reference for Phase 9.2, demonstrates routine data structure</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists with correct SQL schema
- [ ] `npx supabase db push` succeeded
- [ ] TypeScript types regenerated with skincare_routines
- [ ] `npm run build` succeeds without errors
- [ ] Sample data helper created for UI reference
</verification>

<success_criteria>

- skincare_routines table created in Supabase
- Table supports 14 routine slots per user (7 days Ã— 2 times)
- JSONB steps column allows flexible step data (text, order, id, future: completed state)
- RLS policies ensure users only access their own routines
- TypeScript types available for type-safe queries
- Sample data helper provides structure reference for Phase 9.2
- All verification checks pass
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/9.1-skincare-routine-schema/9.1-01-SUMMARY.md`:

# Phase 9.1 Plan 1: Skincare Routine Schema Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Created skincare_routines table for weekly routine tracking
- Applied migration to Supabase with RLS policies
- Generated TypeScript types for type-safe queries
- Created sample data helper for UI development reference

## Files Created/Modified

- `supabase/migrations/20260119_create_skincare_routine_schema.sql` - Routine schema with 14 slots per user
- `lib/database.types.ts` - Updated with SkincareRoutines type
- `lib/skincare-seed.ts` - Sample routine data structure

## Decisions Made

**Schema design:**
- Used single skincare_routines table with (user_id, day_of_week, time_of_day) unique constraint
- JSONB steps column for flexibility (vs separate routine_steps table)
- ISO 8601 day numbering (1=Monday, 7=Sunday) for consistency
- Step objects include id, order, text fields (extensible for future features like completed state)

**Coexistence with deprecated schema:**
- New routine schema coexists with deprecated reminder schema (skincare_settings, night_messages)
- No conflicts - serve different purposes until deprecation cleanup
- Future: remove deprecated tables after confirming routine tracker working

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 9.1-02-PLAN.md if splitting, or Phase 9.2 (Routine Management UI) if phase complete
</output>
