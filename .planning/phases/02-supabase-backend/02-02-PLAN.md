---
phase: 02-supabase-backend
plan: 02
type: execute
---

<objective>
Create database schema for budgets, transactions, and categories with Row Level Security policies.

Purpose: Establish the core data model for the Finance module with secure single-user access control.
Output: Working database tables with RLS policies and TypeScript types generated from schema.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-supabase-backend/DISCOVERY.md
@.planning/phases/02-supabase-backend/02-01-SUMMARY.md

**Tech stack available:**
- next-js@16.1.1, typescript@5, tailwind-css@4, app-router
- @supabase/supabase-js, @supabase/ssr (from Plan 1)

**From Discovery:**
- Use `numeric(10,2)` for currency (not float - precision issues)
- Use `timestamptz` for all timestamps (timezone-aware)
- Index all foreign keys for performance (Supabase best practice)
- Enable RLS on all user-facing tables
- Use `auth.uid()` for single-user policies

**Prerequisites:**
- Supabase client utilities created (Plan 1)
- Real Supabase credentials in .env.local (user action from Plan 1)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema migration with tables and RLS policies</name>
  <files>supabase/migrations/20260111_create_finance_schema.sql</files>
  <action>
    Create `supabase/migrations/` directory at project root.

    Create migration file `20260111_create_finance_schema.sql` with:

    1. **budgets table:**
       - id bigint generated always as identity primary key
       - user_id uuid references auth.users(id) on delete cascade not null
       - month text not null (format: "2024-01")
       - total_budget numeric(10,2) not null
       - created_at timestamptz default now()
       - Unique constraint on (user_id, month)
       - Index on user_id

    2. **categories table:**
       - id bigint generated always as identity primary key
       - user_id uuid references auth.users(id) on delete cascade not null
       - name text not null
       - color text (for UI, nullable, e.g., "#3B82F6")
       - created_at timestamptz default now()
       - Index on user_id

    3. **transactions table:**
       - id bigint generated always as identity primary key
       - user_id uuid references auth.users(id) on delete cascade not null
       - budget_id bigint references budgets(id) on delete cascade not null
       - category_id bigint references categories(id) on delete set null (nullable - uncategorized OK)
       - amount numeric(10,2) not null
       - note text (nullable)
       - transaction_date timestamptz default now() not null
       - source text default 'manual' not null (track entry method: 'manual', 'sms')
       - created_at timestamptz default now()
       - Indexes on user_id, budget_id, category_id

    4. **Enable RLS on all three tables**

    5. **Create RLS policies for each table:**
       - SELECT policy: "Users can view their own [resource]" using ((select auth.uid()) = user_id)
       - INSERT policy: "Users can create their own [resource]" with check ((select auth.uid()) = user_id)
       - UPDATE policy: "Users can update their own [resource]" using + with check auth.uid() = user_id
       - DELETE policy: "Users can delete their own [resource]" using ((select auth.uid()) = user_id)

    Use exact SQL patterns from DISCOVERY.md to avoid common pitfalls.
  </action>
  <verify>
    - Migration file exists at supabase/migrations/20260111_create_finance_schema.sql
    - File contains CREATE TABLE statements for budgets, categories, transactions
    - File contains CREATE INDEX statements for all foreign keys
    - File contains ALTER TABLE...ENABLE ROW LEVEL SECURITY for all tables
    - File contains CREATE POLICY statements (4 per table = 12 total policies)
    - SQL syntax is valid (no obvious typos)
  </verify>
  <done>Database schema migration file created with tables, indexes, and RLS policies</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration to Supabase database</name>
  <files>supabase/migrations/20260111_create_finance_schema.sql (executing)</files>
  <action>
    Connect to Supabase database and execute the migration.

    Options (in order of preference):
    1. If Supabase CLI is available: Run `npx supabase db push`
    2. If CLI not available: Read migration file content and execute via Supabase Dashboard SQL Editor
    3. Alternative: Use `createClient` from lib/supabase/server.ts to execute raw SQL (not recommended for DDL)

    Preferred approach: Use Supabase CLI for proper migration tracking.

    If CLI not installed, install it: `npm install -D supabase`
    Then initialize: `npx supabase init` (creates supabase/ directory structure)
    Link project: `npx supabase link --project-ref [ref-from-url]`
    Push migration: `npx supabase db push`

    Verify migration succeeded by checking for errors in output.
  </action>
  <verify>
    - Migration executed successfully (no SQL errors in output)
    - Tables exist: budgets, categories, transactions
    - RLS is enabled on all three tables
    - Can query tables (even if empty): SELECT * FROM budgets, categories, transactions
  </verify>
  <done>Database schema deployed to Supabase with all tables, indexes, and RLS policies active</done>
</task>

<task type="auto">
  <name>Task 3: Generate TypeScript types from database schema</name>
  <files>lib/database.types.ts</files>
  <action>
    Generate TypeScript types from the Supabase schema for type-safe database queries.

    Use Supabase CLI: `npx supabase gen types typescript --project-id [project-ref] > lib/database.types.ts`

    If CLI gen command fails, create manual types file with interfaces for:
    - Database: { public: { Tables: { budgets: {...}, categories: {...}, transactions: {...} } } }
    - Include Row, Insert, Update types per Supabase conventions

    Preferred: Use CLI generation for accuracy and automatic updates.

    Verify types include budgets, categories, transactions tables with correct column types.
  </action>
  <verify>
    - lib/database.types.ts exists
    - File exports Database type
    - Database.public.Tables includes budgets, categories, transactions
    - Column types match schema (user_id: string/uuid, amount: number, etc.)
    - No TypeScript compilation errors after types added
  </verify>
  <done>TypeScript types generated from schema for type-safe Supabase queries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file created with tables + indexes + RLS policies
- [ ] Migration applied to Supabase (tables exist in database)
- [ ] RLS enabled on budgets, categories, transactions tables
- [ ] TypeScript types generated and compile without errors
- [ ] Can query tables from Supabase (verify connection works)
- [ ] No SQL errors or TypeScript errors introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Database schema deployed with proper structure
- RLS policies active for single-user security
- TypeScript types available for type-safe queries
- Phase 2 complete - Ready for Phase 3: Budget Management UI
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-backend/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Database Schema Migration - Summary

**Finance module database schema deployed with budgets, categories, transactions tables and Row Level Security.**

## Accomplishments

- Created database migration with budgets, categories, transactions tables
- Applied migration to Supabase database
- Enabled Row Level Security on all user-facing tables
- Created 12 RLS policies (4 per table) for single-user access control
- Indexed all foreign keys for query performance
- Generated TypeScript types from schema for type-safe queries

## Files Created/Modified

- `supabase/migrations/20260111_create_finance_schema.sql` - Database schema definition
- `lib/database.types.ts` - Generated TypeScript types from schema

## Decisions Made

- Used `numeric(10,2)` for currency amounts (avoids float precision issues)
- Used `timestamptz` for all timestamps (timezone-aware)
- Made category_id nullable in transactions (uncategorized transactions allowed)
- Added `source` column to transactions ('manual' vs 'sms') for tracking entry method
- Used `on delete cascade` for budgets/categories (delete user â†’ delete data)
- Used `on delete set null` for transaction.category_id (keep transaction if category deleted)

## Issues Encountered

None

## Next Phase Readiness

**Phase 3: Budget Management** is ready to proceed.

The backend provides:
- Database tables for storing budget and transaction data
- RLS policies ensuring users only access their own data
- TypeScript types for type-safe database operations
- Supabase client utilities for querying from UI components

---

*Phase 2 complete. Ready for Phase 3.*
</output>
