---
phase: 11-scheduler-setup
plan: 01
type: execute
---

<objective>
Set up database infrastructure and morning reminder cron endpoint for daily SMS scheduling.

Purpose: Establish the foundation for automated SMS reminders by creating the idempotency tracking table and implementing the morning reminder cron job with proper authorization and error handling.
Output: Working morning reminder endpoint at `/api/cron/send-morning-reminder` with database logging, ready for Vercel Cron configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-scheduler-setup/11-RESEARCH.md
@.planning/phases/09-skincare-schema/09-01-SUMMARY.md
@.planning/phases/10-settings-ui/10-02-SUMMARY.md
@.planning/phases/05-sms-integration/05-01-SUMMARY.md
@lib/supabase/server.ts
@app/api/sms/route.ts

**Tech stack available:**
- Supabase client utilities (Phase 2)
- Twilio SDK v5.11.2 (Phase 5)
- Next.js Route Handlers (App Router)
- TypeScript types for skincare_settings table (Phase 9)

**Established patterns:**
- Row Level Security with TEMP_USER_ID workaround (Phase 2)
- Supabase migrations via MCP tool (Phase 9)
- Twilio SDK for SMS sending (Phase 5)
- Next.js Route Handler pattern for webhooks (Phase 5)
- Server-side Supabase client creation (Phase 2)

**Constraining decisions:**
- Phase 11 Research: Use Vercel Cron Jobs (not node-cron - doesn't work in serverless)
- Phase 11 Research: CRON_SECRET authorization required for security
- Phase 11 Research: Idempotency via reminder_log table to prevent duplicate sends
- Phase 11 Research: Store execution state in Supabase (don't rely on Vercel logs)
- Phase 5: Twilio credentials already configured (TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, USER_PHONE, TWILIO_PHONE)
- Phase 9: skincare_settings table has morning_message, morning_time, morning_enabled fields
- Phase 10: Settings UI manages morning reminder configuration

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reminder_log table migration for idempotency tracking</name>
  <files>supabase/migrations/20260115_create_reminder_log.sql, lib/database.types.ts</files>
  <action>
Create database migration for `reminder_log` table with these fields:
- id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
- date: date NOT NULL (ISO format YYYY-MM-DD, stores execution day)
- type: text NOT NULL CHECK (type IN ('morning', 'night'))
- message_sid: text (Twilio message SID if sent successfully)
- status: text NOT NULL CHECK (status IN ('sent', 'failed', 'skipped'))
- error: text (error message if status = 'failed')
- created_at: timestamptz DEFAULT now()

Add UNIQUE constraint on (date, type) to prevent duplicate sends on same day. Add index on date for query performance.

Enable Row Level Security on reminder_log table. Create RLS policies:
- SELECT: user_id = TEMP_USER_ID (single-user access)
- INSERT: user_id = TEMP_USER_ID
- UPDATE: user_id = TEMP_USER_ID
- DELETE: user_id = TEMP_USER_ID

Apply migration via Supabase MCP tool: mcp__plugin_supabase_supabase__apply_migration with project_id, name "create_reminder_log", and SQL query.

After migration, regenerate TypeScript types via mcp__plugin_supabase_supabase__generate_typescript_types and update lib/database.types.ts.

Avoid adding user_id column (not needed - RLS policies enforce single-user access, UNIQUE constraint on date+type is sufficient).
  </action>
  <verify>npm run build passes without TypeScript errors, Supabase schema includes reminder_log table</verify>
  <done>Migration applied, reminder_log table exists with UNIQUE(date, type) constraint, RLS policies active, TypeScript types updated</done>
</task>

<task type="auto">
  <name>Task 2: Create morning reminder cron route with authorization and idempotency</name>
  <files>app/api/cron/send-morning-reminder/route.ts</files>
  <action>
Create Next.js Route Handler at `app/api/cron/send-morning-reminder/route.ts` following this pattern (from 11-RESEARCH.md):

1. **Authorization**: Verify `Authorization: Bearer ${CRON_SECRET}` header matches env var. Return 401 if missing or incorrect. Use process.env.CRON_SECRET.

2. **Idempotency check**: Query reminder_log table for today's date + type='morning'. If exists, return { message: 'Already sent today' }. Use `new Date().toISOString().split('T')[0]` for date string.

3. **Fetch settings**: Query skincare_settings table for morning_message and morning_enabled fields using server-side Supabase client (createClient from lib/supabase/server.ts). If morning_enabled is false, return { message: 'Morning reminders disabled' }.

4. **Send SMS**: Use Twilio SDK to send message (same pattern as app/api/sms/route.ts):
   - Import twilio from 'twilio'
   - Create client: twilio(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)
   - Call twilioClient.messages.create({ to: USER_PHONE, from: TWILIO_PHONE, body: morning_message })

5. **Log execution**: Insert into reminder_log table with date, type='morning', message_sid (from Twilio response), status='sent'. On SMS failure, insert with status='failed', error=String(error).

6. **Error handling**: Wrap SMS send in try/catch. Log failures to reminder_log. Return 500 on failure, 200 on success with { success: true, sid, message }.

Return Response.json() for all responses (Next.js App Router pattern). Use console.log for execution logging.

Avoid using date-fns or date-fns-tz (not installed, not needed for simple date string creation). Avoid custom distributed locking (single-user app doesn't need node-redlock). Avoid timezone conversion libraries (hardcode UTC schedule, Vercel Cron runs in UTC).
  </action>
  <verify>curl -X GET http://localhost:3000/api/cron/send-morning-reminder -H "Authorization: Bearer test-secret" returns 401 or executes successfully, npm run build passes</verify>
  <done>Route handler created, authorization check working, idempotency check via reminder_log, SMS sending functional, execution logging to database, build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] reminder_log table exists in Supabase with UNIQUE(date, type)
- [ ] /api/cron/send-morning-reminder returns 401 without proper Authorization header
- [ ] Manual test of morning reminder route (with correct CRON_SECRET) succeeds or logs skipped status
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Database migration applied successfully
- Morning reminder route functional with authorization
- Idempotency prevents duplicate sends via reminder_log table
  </success_criteria>

<output>
After completion, create `.planning/phases/11-scheduler-setup/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Database & Morning Reminder Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- reminder_log table created with idempotency constraint
- Morning reminder cron endpoint with CRON_SECRET authorization
- SMS sending via Twilio SDK integrated with settings
- Database logging for execution tracking and debugging

## Files Created/Modified

- `supabase/migrations/20260115_create_reminder_log.sql` - Idempotency tracking table
- `lib/database.types.ts` - TypeScript types for reminder_log
- `app/api/cron/send-morning-reminder/route.ts` - Cron endpoint for morning reminders

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 11-02-PLAN.md (night reminder and Vercel Cron configuration)
</output>
