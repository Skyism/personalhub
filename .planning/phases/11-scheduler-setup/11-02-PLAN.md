---
phase: 11-scheduler-setup
plan: 02
type: execute
---

<objective>
Implement night reminder cron endpoint with message rotation and deploy scheduler configuration to Vercel.

Purpose: Complete the scheduling infrastructure by adding the night reminder with random message selection from the database list, and configure Vercel Cron to invoke both reminder endpoints at the correct UTC times.
Output: Working night reminder endpoint with message rotation, vercel.json with cron configuration, and CRON_SECRET documented for deployment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-scheduler-setup/11-RESEARCH.md
@.planning/phases/11-scheduler-setup/11-01-PLAN.md
@.planning/phases/09-skincare-schema/09-01-SUMMARY.md
@.planning/phases/10-settings-ui/10-02-SUMMARY.md
@app/api/cron/send-morning-reminder/route.ts

**Tech stack available:**
- Supabase client utilities (Phase 2)
- Twilio SDK v5.11.2 (Phase 5)
- reminder_log table for idempotency (Phase 11 Plan 1)
- morning reminder cron pattern established (Phase 11 Plan 1)

**Established patterns:**
- CRON_SECRET authorization check (Phase 11 Plan 1)
- Idempotency via reminder_log table check (Phase 11 Plan 1)
- SMS sending via Twilio SDK (Phase 5, Phase 11 Plan 1)
- Database execution logging with status tracking (Phase 11 Plan 1)
- Route Handler returning Response.json() (Phase 11 Plan 1)

**Constraining decisions:**
- Phase 11 Research: Use random message selection for night reminders (not sequential tracking - simpler implementation)
- Phase 11 Research: Vercel Cron schedule in UTC (8 AM PST = 16:00 UTC, 8 PM PST = 04:00 UTC next day)
- Phase 11 Research: CRON_SECRET env var for authorization (official Vercel recommendation)
- Phase 10: night_messages table stores list of rotating messages with 160-char limit
- Phase 9: skincare_settings has night_time and night_enabled fields

**Issues being addressed:** None
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create night reminder cron route with random message selection</name>
  <files>app/api/cron/send-night-reminder/route.ts</files>
  <action>
Create Next.js Route Handler at `app/api/cron/send-night-reminder/route.ts` following the morning reminder pattern from 11-01-PLAN.md:

1. **Authorization**: Verify `Authorization: Bearer ${CRON_SECRET}` header. Return 401 if incorrect.

2. **Idempotency check**: Query reminder_log for today's date + type='night'. Return early if exists.

3. **Fetch settings and messages**:
   - Query skincare_settings for night_enabled field
   - If night_enabled is false, return { message: 'Night reminders disabled' }
   - Query night_messages table for all messages: `supabase.from('night_messages').select('id, message').eq('user_id', TEMP_USER_ID)`

4. **Random message selection**:
   - If night_messages array is empty, return { message: 'No night messages configured' } with status='skipped' logged
   - Select random message: `messages[Math.floor(Math.random() * messages.length)]`
   - Use the `message` field as SMS body

5. **Send SMS**: Use Twilio SDK same as morning reminder (twilioClient.messages.create with random message body)

6. **Log execution**: Insert into reminder_log with date, type='night', message_sid, status='sent'. On failure, log status='failed' with error string.

7. **Error handling**: Try/catch around SMS send, log failures to reminder_log, return appropriate status codes.

Follow exact same code structure as app/api/cron/send-morning-reminder/route.ts for consistency. Use console.log for logging. Return Response.json() for all responses.

Avoid sequential message tracking (no last_used_at or rotation counter - research recommends random selection for simplicity). Avoid fetching night_time field (not used - Vercel Cron determines timing, not database).
  </action>
  <verify>Manual test with curl returns appropriate responses for enabled/disabled/no-messages states, build passes without errors</verify>
  <done>Night reminder route created, random message selection working, SMS sending functional, execution logging to reminder_log, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vercel Cron Jobs and document CRON_SECRET</name>
  <files>vercel.json, .env.local.example</files>
  <action>
Create `vercel.json` at project root with Vercel Cron configuration (from 11-RESEARCH.md code examples):

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/cron/send-morning-reminder",
      "schedule": "0 16 * * *"
    },
    {
      "path": "/api/cron/send-night-reminder",
      "schedule": "0 4 * * *"
    }
  ]
}
```

Schedule explanation:
- Morning: "0 16 * * *" = 16:00 UTC = 8:00 AM PST (UTC-8)
- Night: "0 4 * * *" = 04:00 UTC = 8:00 PM PST previous day (UTC-8, wraps to next day)

Update `.env.local.example` to add CRON_SECRET documentation:

```
# Cron Job Authentication (for Vercel Cron)
CRON_SECRET=your-random-secret-here
```

Add comment explaining: "Generate a random secret for production (e.g., openssl rand -base64 32). Used by Vercel Cron to authenticate scheduled job requests."

Do NOT generate an actual CRON_SECRET value in .env.local (user will add their own for production deployment). Avoid adding cron configuration to .env files (Vercel Cron reads from vercel.json, not env vars).
  </action>
  <verify>vercel.json exists with valid JSON structure, .env.local.example documents CRON_SECRET, npm run build passes</verify>
  <done>vercel.json created with both cron jobs, CRON_SECRET documented in .env.local.example with generation instructions, build passes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] vercel.json exists with valid cron schedule syntax
- [ ] Both cron endpoints (/api/cron/send-morning-reminder and /api/cron/send-night-reminder) respond to requests
- [ ] Night reminder selects random message from night_messages table
- [ ] .env.local.example documents CRON_SECRET with generation instructions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Night reminder route functional with random message rotation
- Vercel Cron configuration ready for deployment
- CRON_SECRET documented for production setup
- Phase 11 complete - scheduler infrastructure ready
  </success_criteria>

<output>
After completion, create `.planning/phases/11-scheduler-setup/11-02-SUMMARY.md`:

# Phase 11 Plan 2: Night Reminder & Deployment Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Night reminder cron endpoint with random message selection
- Vercel Cron configuration for both morning (16:00 UTC) and night (04:00 UTC) reminders
- CRON_SECRET authentication documented for production deployment
- Complete scheduler infrastructure ready for Phase 12 SMS integration

## Files Created/Modified

- `app/api/cron/send-night-reminder/route.ts` - Night reminder cron endpoint with message rotation
- `vercel.json` - Vercel Cron Jobs configuration
- `.env.local.example` - CRON_SECRET documentation

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 11 complete. Phase 12 (SMS Reminders) ready to proceed with:
- Working cron endpoints for morning and night reminders
- Idempotency via reminder_log preventing duplicate sends
- CRON_SECRET authorization protecting endpoints
- Vercel Cron configuration ready for deployment
- Random message rotation for night reminders
</output>
